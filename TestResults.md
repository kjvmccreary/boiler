Building Test Projects
Starting test discovery for requested test run
========== Starting test discovery ==========
[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.5.3.1+6b60a9e56a (64-bit .NET 9.0.7)
[xUnit.net 00:00:00.07]   Discovering: UserService.IntegrationTests
[xUnit.net 00:00:00.12]   Discovered:  UserService.IntegrationTests
========== Test discovery finished: 180 Tests found in 559.1 ms ==========
========== Starting test run ==========
[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.5.3.1+6b60a9e56a (64-bit .NET 9.0.7)
[xUnit.net 00:00:00.05]   Starting:    UserService.IntegrationTests
=== UserService Startup Diagnostics ===
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Application Name: UserService
Running in Container: 
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Performance/Testing environment: True
?? Performance/Testing environment: True
? Using in-memory cache services (Performance/Testing mode)
?? Performance/Testing environment: True
? Using in-memory cache services (Performance/Testing mode)
? Using in-memory cache services (Performance/Testing mode)
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Performance/Testing environment: True
? Using in-memory cache services (Performance/Testing mode)
? Cache services configured
?? Registering database services...
? Cache services configured
?? Registering database services...
? Cache services configured
?? Registering database services...
? Cache services configured
?? Registering database services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? Enhanced Security and Monitoring services registered successfully
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Authorization policies configured
?? Configuring CORS...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
[15:31:12 INF] Configuring Enhanced Security middleware {}
[15:31:12 INF] Configuring Enhanced Security middleware {}
[15:31:12 INF] Configuring Enhanced Security middleware {}
[15:31:12 INF] Configuring Enhanced Security middleware {}
[15:31:12 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[15:31:12 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[15:31:12 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[15:31:12 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
? Enhanced Security middleware configured successfully
[15:31:12 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[15:31:12 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[15:31:12 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[15:31:12 INF] Enhanced Security middleware configured successfully {}
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
[15:31:12 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[15:31:12 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[15:31:12 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[15:31:12 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing cache connection...
? In-memory cache configured (Performance/Testing mode)
[15:31:12 INF] In-memory cache configured for Performance/Testing environment {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing cache connection...
? In-memory cache configured (Performance/Testing mode)
[15:31:12 INF] In-memory cache configured for Performance/Testing environment {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing cache connection...
? In-memory cache configured (Performance/Testing mode)
?? Seeding database...
[15:31:12 INF] In-memory cache configured for Performance/Testing environment {}
?? Seeding database...
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing cache connection...
? In-memory cache configured (Performance/Testing mode)
?? Seeding database...
[15:31:12 INF] In-memory cache configured for Performance/Testing environment {}
?? Seeding database...
[15:31:12 WRN] Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development. {"EventId": {"Id": 10400, "Name": "Microsoft.EntityFrameworkCore.Infrastructure.SensitiveDataLoggingEnabledWarning"}, "SourceContext": "Microsoft.EntityFrameworkCore.Model.Validation"}
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
[15:31:13 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[15:31:13 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[15:31:13 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[15:31:13 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[15:31:13 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[15:31:13 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[15:31:13 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[15:31:13 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
? Database recreated with clean state
? Database recreated with clean state
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
?? Creating 38 permissions from actual business requirements
   - billing.process_payments (Billing)
   - billing.manage (Billing)
?? Creating 38 permissions from actual business requirements
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - billing.manage (Billing)
   - reports.schedule (Reports)
   - billing.process_payments (Billing)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - billing.view (Billing)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - billing.view_invoices (Billing)
   - billing.view (Billing)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - permissions.create (Permissions)
   - billing.view_invoices (Billing)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.create (Permissions)
   - system.manage (System)
   - system.manage_backups (System)
   - permissions.delete (Permissions)
   - permissions.manage (Permissions)
   - system.manage_settings (System)
   - system.monitor (System)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - billing.process_payments (Billing)
   - roles.create (Roles)
   - roles.delete (Roles)
   - billing.view (Billing)
   - roles.edit (Roles)
   - permissions.edit (Permissions)
   - roles.manage_permissions (Roles)
   - permissions.manage (Permissions)
   - billing.view_invoices (Billing)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - permissions.create (Permissions)
   - roles.assign_users (Roles)
   - permissions.delete (Permissions)
   - roles.create (Roles)
   - permissions.edit (Permissions)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - roles.manage_permissions (Roles)
   - system.view_logs (System)
   - reports.create (Reports)
   - roles.view (Roles)
   - system.view_metrics (System)
   - system.manage (System)
   - system.manage_backups (System)
   - reports.export (Reports)
   - tenants.create (Tenants)
   - reports.schedule (Reports)
   - system.manage_settings (System)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - reports.view (Reports)
   - tenants.initialize (Tenants)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - roles.assign_users (Roles)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - users.view_all (Users)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - tenants.manage_settings (Tenants)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - tenants.delete (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - roles.create (Roles)
   - users.view_all (Users)
   - tenants.edit (Tenants)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
?? Creating roles...
?? Creating roles...
?? Creating roles...
?? Creating roles...
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
   - tenant1.Id = 1
   - tenant2.Id = 2
?? CreateRoles DEBUG:
?? Roles to be created (8):
?? Roles to be created (8):
   - tenant1.Id = 1
   - tenant2.Id = 2
?? CreateRoles DEBUG:
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   1. SuperAdmin (TenantId: )
   1. SuperAdmin (TenantId: )
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   2. Admin (TenantId: 1)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   3. User (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   4. Manager (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   6. Editor (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   7. Admin (TenantId: 2)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   8. User (TenantId: 2)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
?? Verification - Created roles:
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=5, Name='Viewer', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
?? Verification - Created roles:
   - ID=3, Name='User', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=2, Name='Admin', TenantId=1
?? Verification - Created roles:
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=3, Name='User', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Found 38 permissions and 8 roles
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=5, Name='Viewer', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 28 permissions to Tenant1 Admin
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - tenant2.Id = 2
   - All roles count: 8
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole found: True
   - tenant2AdminRole found: True
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2AdminRole.Id = 7
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? admin@tenant1.com has 1 role assignments
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? TestDataSeeder: Test data seeding completed successfully
[15:31:13 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? MOCKING two-phase flow for admin@tenant2.com  Tenant 2
?? MOCKING two-phase flow for user@tenant1.com  Tenant 1
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
?? MOCKING two-phase flow for admin@tenant2.com  Tenant 2
? Phase 1 simulated: User user@tenant1.com authenticated (mocked)
? Phase 1 simulated: User admin@tenant2.com authenticated (mocked)
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 1 simulated: User admin@tenant2.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 2
? Phase 2 simulated: Tenant access verified for tenant 1
? Phase 2 simulated: Tenant access verified for tenant 1
? Phase 2 simulated: Tenant access verified for tenant 2
?? MOCKING two-phase flow for admin@tenant2.com  Tenant 2
? Phase 1 simulated: User admin@tenant2.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 2
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 1
[15:31:13 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2GG0EJEC1", "RequestPath": "/api/users"}
[15:31:13 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2GG0EJEC0", "RequestPath": "/api/users/1"}
[15:31:13 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2GG0EJEBV", "RequestPath": "/api/roles"}
[15:31:13 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2GG0EJEBU", "RequestPath": "/api/users/1"}
[15:31:13 DBG] Successfully validated the token. {"EventId": {"Id": 2, "Name": "TokenValidationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEC0", "RequestPath": "/api/users/1"}
[15:31:13 DBG] Successfully validated the token. {"EventId": {"Id": 2, "Name": "TokenValidationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEC1", "RequestPath": "/api/users"}
[15:31:13 DBG] Successfully validated the token. {"EventId": {"Id": 2, "Name": "TokenValidationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEBV", "RequestPath": "/api/roles"}
[15:31:13 DBG] Successfully validated the token. {"EventId": {"Id": 2, "Name": "TokenValidationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEBU", "RequestPath": "/api/users/1"}
[15:31:13 DBG] AuthenticationScheme: Bearer was successfully authenticated. {"EventId": {"Id": 8, "Name": "AuthenticationSchemeAuthenticated"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEC1", "RequestPath": "/api/users"}
[15:31:13 DBG] AuthenticationScheme: Bearer was successfully authenticated. {"EventId": {"Id": 8, "Name": "AuthenticationSchemeAuthenticated"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEC0", "RequestPath": "/api/users/1"}
[15:31:13 DBG] AuthenticationScheme: Bearer was successfully authenticated. {"EventId": {"Id": 8, "Name": "AuthenticationSchemeAuthenticated"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEBU", "RequestPath": "/api/users/1"}
[15:31:13 DBG] AuthenticationScheme: Bearer was successfully authenticated. {"EventId": {"Id": 8, "Name": "AuthenticationSchemeAuthenticated"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2GG0EJEBV", "RequestPath": "/api/roles"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEC0", "RequestPath": "/api/users/1"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEBV", "RequestPath": "/api/roles"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEBU", "RequestPath": "/api/users/1"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEC1", "RequestPath": "/api/users"}
[15:31:13 WRN] User 2 attempted to view user 1 without users.view permission {"SourceContext": "UserService.Controllers.UsersController", "ActionId": "438323c5-3063-4be6-b837-05e4b06dd5a1", "ActionName": "UserService.Controllers.UsersController.GetUser (UserService)", "RequestId": "0HNF2GG0EJEC0", "RequestPath": "/api/users/1"}
[15:31:13 INF] HTTP GET /api/roles responded 200 in 108.2755 ms {"SourceContext": "Serilog.AspNetCore.RequestLoggingMiddleware"}
[15:31:13 INF] HTTP GET /api/users/1 responded 403 in 128.8354 ms {"SourceContext": "Serilog.AspNetCore.RequestLoggingMiddleware"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEC2", "RequestPath": "/api/roles/1/permissions"}
[15:31:13 DBG] Authorization was successful. {"EventId": {"Id": 1, "Name": "UserAuthorizationSucceeded"}, "SourceContext": "Microsoft.AspNetCore.Authorization.DefaultAuthorizationService", "RequestId": "0HNF2GG0EJEC3", "RequestPath": "/api/users/5/roles/2"}
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[xUnit.net 00:00:01.52]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_CrossTenantAttempt_ReturnsNotFound [FAIL]
[xUnit.net 00:00:01.52]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.OK {value: 200}.
[xUnit.net 00:00:01.52]       Stack Trace:
? Created 38 permissions
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Creating roles...
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.52]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
[xUnit.net 00:00:01.52]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(471,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_CrossTenantAttempt_ReturnsNotFound()
?? Roles to be created (8):
[xUnit.net 00:00:01.52]         --- End of stack trace from previous location ---
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:01.52]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.RemoveRoleFromUser_CrossTenantRole_ShouldFail [FAIL]
[xUnit.net 00:00:01.52]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.BadRequest {value: 400}.
[xUnit.net 00:00:01.52]       Stack Trace:
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 8 roles
?? Verification - Created roles:
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.52]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:01.52]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.52]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(208,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.RemoveRoleFromUser_CrossTenantRole_ShouldFail()
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.52]         --- End of stack trace from previous location ---
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[15:31:13 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[15:31:13 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 1
?? MOCKING two-phase flow for admin@tenant2.com  Tenant 1
? Phase 1 simulated: User admin@tenant2.com authenticated (mocked)
[xUnit.net 00:00:01.54]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_CrossTenantAttempt_ReturnsNotFound [FAIL]
[xUnit.net 00:00:01.54]       System.UnauthorizedAccessException : User admin@tenant2.com does not have access to tenant 1
[xUnit.net 00:00:01.54]       Stack Trace:
[xUnit.net 00:00:01.54]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\TestUtilities\AuthenticationHelper.cs(92,0): at UserService.IntegrationTests.TestUtilities.AuthenticationHelper.GetTenantTokenViaTwoPhaseFlow(HttpClient client, ApplicationDbContext dbContext, String email, Int32 preferredTenantId)
[xUnit.net 00:00:01.54]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\TestUtilities\AuthenticationHelper.cs(338,0): at UserService.IntegrationTests.TestUtilities.AuthenticationHelper.GetTenantAwareJwtAsync(HttpClient client, ApplicationDbContext dbContext, String email, Nullable`1 preferredTenantId)
[xUnit.net 00:00:01.54]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\TestBase.cs(137,0): at UserService.IntegrationTests.TestBase.GetAuthTokenAsync(String email, Nullable`1 tenantId)
[xUnit.net 00:00:01.54]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(403,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_CrossTenantAttempt_ReturnsNotFound()
[xUnit.net 00:00:01.54]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.54]   Finished:    UserService.IntegrationTests
========== Test run finished: 5 Tests (2 Passed, 3 Failed, 0 Skipped) run in 1.6 sec ==========
