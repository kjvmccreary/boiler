Building Test Projects
========== Starting test run ==========
[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.5.3.1+6b60a9e56a (64-bit .NET 9.0.7)
[xUnit.net 00:00:00.06]   Starting:    UserService.IntegrationTests
=== UserService Startup Diagnostics ===
=== UserService Startup Diagnostics ===
Environment: Testing
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Application Name: UserService
Running in Container: 
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
[Startup] Monitoring:Enabled raw config value = 'False'
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
?? Registering base services...
? Base services registered
?? Configuring Swagger...
? Base services registered
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Base services registered
?? Configuring Swagger...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Swagger configured
?? Registering common services...
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
?? Running in container: 
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
?? Running in container: 
? Common services registered
?? Configuring Redis...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
? Common services registered
?? Configuring Redis...
?? Running in container: 
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
? Common services registered
?? Configuring Redis...
? Common services registered
?? Redis connection string resolved to: localhost:6379
?? Configuring Redis...
?? Running in container: 
?? Redis connection string resolved to: localhost:6379
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
?? Running in container: 
?? Running in container: 
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Redis configured
?? Registering database services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? Database services registered
?? Registering user services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
? User services registered
? User services registered
?? Registering Enhanced Security and Monitoring services...
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
?? Registering Compliance and Alert services...
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
? Enhanced Health Checks registered
?? Configuring authorization policies...
?? Configuring authorization policies...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? Authorization policies configured
? Authorization policies configured
?? Configuring CORS...
? Authorization policies configured
?? Configuring CORS...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Enhanced Health Checks registered
?? Configuring authorization policies...
?? Configuring authorization policies...
? CORS configured
?? Registering additional services...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Authorization policies configured
?? Configuring CORS...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Authorization policies configured
?? Configuring CORS...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Additional services registered
??? Building application...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
? CORS configured
?? Registering additional services...
?? Registering additional services...
? Authorization policies configured
?? Configuring CORS...
? Additional services registered
??? Building application...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Additional services registered
??? Building application...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
? Application built successfully
?? Configuring middleware pipeline...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
?? Configuring Enhanced Security middleware...
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] Configuring Enhanced Security middleware {}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
[12:51:30 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
? Enhanced Security middleware configured successfully
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Enhanced Security middleware configured successfully
[12:51:30 INF] Enhanced Security middleware configured successfully {}
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
? Enhanced Health Check endpoints mapped
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
? Enhanced Health Check endpoints mapped
? Enhanced Health Check endpoints mapped
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
? Enhanced Health Check endpoints mapped
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
? Enhanced Health Check endpoints mapped
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
? Enhanced Health Check endpoints mapped
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[12:51:30 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
[12:51:30 INF] Redis connection status: Connected {}
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
? Redis connection successful: 8/23/2025 5:51:30 PM
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
?? Seeding database...
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
?? Seeding database...
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
?? Seeding database...
?? Seeding database...
[12:51:30 INF] Redis connection test successful: 8/23/2025 5:51:30 PM {}
?? Seeding database...
?? Seeding database...
?? Seeding database...
?? Seeding database...
?? Seeding database...
?? Seeding database...
?? Seeding database...
[12:51:30 WRN] Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development. {"EventId": {"Id": 10400, "Name": "Microsoft.EntityFrameworkCore.Infrastructure.SensitiveDataLoggingEnabledWarning"}, "SourceContext": "Microsoft.EntityFrameworkCore.Model.Validation"}
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
? Database seeded
?? Seeding monitoring user...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
[12:51:31 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
  - Rate limiting with tenant awareness
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:31 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
? Database recreated with clean state
? Database recreated with clean state
? Database recreated with clean state
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
?? Creating tenants...
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
? Created 2 tenants
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - billing.view_invoices (Billing)
?? Creating 38 permissions from actual business requirements
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
?? Creating 38 permissions from actual business requirements
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - reports.create (Reports)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - users.delete (Users)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.create (Permissions)
   - users.edit (Users)
   - permissions.delete (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
?? Creating 38 permissions from actual business requirements
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - roles.delete (Roles)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - billing.view (Billing)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - billing.view_invoices (Billing)
   - system.view_metrics (System)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - permissions.edit (Permissions)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - users.view (Users)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - users.view_all (Users)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - billing.manage (Billing)
   - roles.view (Roles)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - system.manage (System)
   - system.manage_backups (System)
   - permissions.create (Permissions)
   - system.manage_settings (System)
   - permissions.delete (Permissions)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - billing.process_payments (Billing)
   - users.create (Users)
   - billing.view (Billing)
   - users.delete (Users)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - users.edit (Users)
   - users.manage_roles (Users)
   - permissions.delete (Permissions)
   - reports.view (Reports)
   - users.view (Users)
   - users.view_all (Users)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
?? Creating 38 permissions from actual business requirements
   - tenants.initialize (Tenants)
   - billing.manage (Billing)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.manage_roles (Users)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - permissions.edit (Permissions)
   - system.manage (System)
   - permissions.manage (Permissions)
   - system.manage_backups (System)
   - permissions.view (Permissions)
   - system.manage_settings (System)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - system.monitor (System)
   - reports.view (Reports)
   - system.view_logs (System)
   - roles.assign_users (Roles)
   - system.view_metrics (System)
   - roles.create (Roles)
   - tenants.create (Tenants)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - tenants.delete (Tenants)
   - roles.view (Roles)
   - tenants.edit (Tenants)
   - system.manage (System)
   - tenants.initialize (Tenants)
   - system.manage_backups (System)
   - tenants.manage_settings (Tenants)
   - system.manage_settings (System)
   - system.monitor (System)
   - tenants.view (Tenants)
   - system.view_logs (System)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - billing.view_invoices (Billing)
   - users.delete (Users)
   - users.edit (Users)
   - permissions.create (Permissions)
   - users.manage_roles (Users)
   - permissions.delete (Permissions)
   - users.view (Users)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - permissions.edit (Permissions)
   - tenants.view_all (Tenants)
   - permissions.manage (Permissions)
   - users.create (Users)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - users.delete (Users)
   - reports.view (Reports)
   - users.edit (Users)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - users.manage_roles (Users)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - users.view (Users)
   - roles.view (Roles)
   - users.view_all (Users)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - users.view_all (Users)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
? Created 38 permissions
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - permissions.edit (Permissions)
   - billing.view_invoices (Billing)
   - permissions.manage (Permissions)
   - permissions.create (Permissions)
   - permissions.view (Permissions)
   - permissions.delete (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - permissions.edit (Permissions)
   - roles.assign_users (Roles)
   - permissions.manage (Permissions)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
?? Creating roles...
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
?? Creating roles...
?? Creating roles...
?? Creating roles...
?? Creating roles...
?? Creating roles...
   - permissions.view (Permissions)
   - system.view_metrics (System)
   - reports.create (Reports)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - reports.export (Reports)
?? Creating roles...
?? Creating roles...
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
? Created 38 permissions
?? Creating roles...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   - tenant1.Id = 1
?? Roles to be created (8):
   - tenant1.Id = 1
   - tenant2.Id = 2
   - tenant2.Id = 2
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   1. SuperAdmin (TenantId: )
   - tenant1.Id = 1
   - tenant2.Id = 2
?? CreateRoles DEBUG:
?? Roles to be created (8):
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   1. SuperAdmin (TenantId: )
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
   - tenant1.Id = 1
   - tenant2.Id = 2
?? CreateRoles DEBUG:
   - tenant2.Id = 2
?? Roles to be created (8):
   2. Admin (TenantId: 1)
   2. Admin (TenantId: 1)
?? Roles to be created (8):
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   - tenant1.Id = 1
   - tenant2.Id = 2
   7. Admin (TenantId: 2)
?? Roles to be created (8):
   8. User (TenantId: 2)
   1. SuperAdmin (TenantId: )
?? Roles to be created (8):
   2. Admin (TenantId: 1)
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   - tenant1.Id = 1
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   - tenant2.Id = 2
   8. User (TenantId: 2)
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   - tenant1.Id = 1
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   - tenant2.Id = 2
   4. Manager (TenantId: 1)
?? Roles to be created (8):
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   1. SuperAdmin (TenantId: )
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - tenant1.Id = 1
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   1. SuperAdmin (TenantId: )
   3. User (TenantId: 1)
   2. Admin (TenantId: 1)
   4. Manager (TenantId: 1)
   3. User (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   4. Manager (TenantId: 1)
   7. Admin (TenantId: 2)
   5. Viewer (TenantId: 1)
   8. User (TenantId: 2)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   3. User (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   4. Manager (TenantId: 1)
   6. Editor (TenantId: 1)
   5. Viewer (TenantId: 1)
?? Roles to be created (8):
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   7. Admin (TenantId: 2)
   1. SuperAdmin (TenantId: )
   8. User (TenantId: 2)
   8. User (TenantId: 2)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - tenant2.Id = 2
   7. Admin (TenantId: 2)
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   8. User (TenantId: 2)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
? Created 8 roles
?? Verification - Created roles:
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
?? Verification - Created roles:
   - ID=5, Name='Viewer', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=4, Name='Manager', TenantId=1
?? Verification - Created roles:
   - ID=7, Name='Admin', TenantId=2
?? Verification - Created roles:
   - ID=6, Name='Editor', TenantId=1
   - ID=8, Name='User', TenantId=2
?? Verification - Created roles:
?? Verification - Created roles:
   - ID=7, Name='Admin', TenantId=2
   - ID=8, Name='User', TenantId=2
?? Verification - Created roles:
   - ID=6, Name='Editor', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=5, Name='Viewer', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=3, Name='User', TenantId=1
?? Verification - Created roles:
   - ID=4, Name='Manager', TenantId=1
?? Verification - Created roles:
   - ID=2, Name='Admin', TenantId=1
   - ID=8, Name='User', TenantId=2
?? Verification - Created roles:
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=2, Name='Admin', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
? Successfully created all 8 roles including 2 Tenant 2 roles
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=8, Name='User', TenantId=2
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=7, Name='Admin', TenantId=2
   - ID=7, Name='Admin', TenantId=2
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=6, Name='Editor', TenantId=1
   - ID=8, Name='User', TenantId=2
?? Creating role permissions...
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=7, Name='Admin', TenantId=2
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=6, Name='Editor', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=5, Name='Viewer', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=3, Name='User', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=5, Name='Viewer', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=3, Name='User', TenantId=1
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=2, Name='Admin', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=4, Name='Manager', TenantId=1
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
? Assigned 38 permissions to SuperAdmin
   - ID=8, Name='User', TenantId=2
? Assigned 38 permissions to SuperAdmin
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
? Assigned 38 permissions to SuperAdmin
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
   - ID=3, Name='User', TenantId=1
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - tenant2.Id = 2
   - All roles count: 8
   - tenant2.Id = 2
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - tenant2.Id = 2
   - All roles count: 8
   - All roles count: 8
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - All roles count: 8
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - tenant2.Id = 2
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - Roles with TenantId = 2: 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole found: True
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole found: True
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2AdminRole found: True
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole found: True
   - tenant2AdminRole found: True
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - tenant2AdminRole.Id = 7
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2AdminRole found: True
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - tenant2AdminRole.Id = 7
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - tenant2AdminRole.Id = 7
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 3 permissions to Tenant2 User
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2AdminRole found: True
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - tenant2AdminRole.Id = 7
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 3 permissions to Tenant2 User
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 3 permissions to Tenant2 User
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
?? Creating users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
?? Adding 7 users to main context
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? All users created successfully
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant2.com (ID:  7)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant1.com (ID:  1)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
?? Adding 8 user role assignments...
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
?? Creating legacy tenant users...
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 1
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Two-phase flow simulation completed successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Roles: Admin
   - Tenant: Test Tenant 1 (ID: 1)
   - Permissions: 28
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THP", "RequestPath": "/api/roles/1"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THR", "RequestPath": "/api/roles"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THQ", "RequestPath": "/api/users"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THS", "RequestPath": "/api/users/2/roles/1"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THU", "RequestPath": "/api/users/3/roles"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3TI2", "RequestPath": "/api/roles"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THT", "RequestPath": "/api/roles"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3THV", "RequestPath": "/api/roles"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3TI1", "RequestPath": "/api/tenants"}
[12:51:31 WRN] Failed to determine the https port for redirect. {"EventId": {"Id": 3, "Name": "FailedToDeterminePort"}, "SourceContext": "Microsoft.AspNetCore.HttpsPolicy.HttpsRedirectionMiddleware", "RequestId": "0HNF2DMOP3TI0", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.54]     UserService.IntegrationTests.Infrastructure.TestSetupVerificationTests.TestSetup_ShouldCreateAllRequiredTestData [FAIL]
[xUnit.net 00:00:01.55]       Expected permissions to contain 36 item(s), but found 38: 
[xUnit.net 00:00:01.55]       DTOs.Entities.Permission
[xUnit.net 00:00:01.55]           {
[xUnit.net 00:00:01.55]               Category = "Billing", 
[xUnit.net 00:00:01.55]               CreatedAt = <2025-08-23 17:51:31.1986516>, 
[xUnit.net 00:00:01.55]               Description = "Process payments billing", 
[xUnit.net 00:00:01.55]               Id = 2, 
[xUnit.net 00:00:01.55]               IsActive = True, 
[xUnit.net 00:00:01.55]               Name = "billing.process_payments", 
[xUnit.net 00:00:01.55]               {
[xUnit.net 00:00:01.55]               RolePermissions = DTOs.Entities.RolePermission
[xUnit.net 00:00:01.55]                   {
[xUnit.net 00:00:01.55]                       CreatedAt = <2025-08-23 17:51:31.2397315>, 
[xUnit.net 00:00:01.55]                       GrantedAt = <2025-08-23 17:51:31.2236459>, 
[xUnit.net 00:00:01.55]                       GrantedBy = "System", 
[xUnit.net 00:00:01.55]                       Id = 1, 
[xUnit.net 00:00:01.55]                       Permission = {Cyclic reference to type DTOs.Entities.Permission detected}, 
[xUnit.net 00:00:01.55]                       PermissionId = 2, 
[xUnit.net 00:00:01.55]                       Role = DTOs.Entities.Role
[xUnit.net 00:00:01.55]                       {
[xUnit.net 00:00:01.55]                           CreatedAt = <2025-08-23 17:51:31.2150245>, 
[xUnit.net 00:00:01.55]                           Description = "System super admin", 
[xUnit.net 00:00:01.55]                           Id = 1, 
[xUnit.net 00:00:01.55]                           IsActive = True, 
[xUnit.net 00:00:01.55]                           IsDefault = False, 
[xUnit.net 00:00:01.55]                           IsSystemRole = True, 
[xUnit.net 00:00:01.55]                           Name = "SuperAdmin", 
[xUnit.net 00:00:01.55]                           {
[xUnit.net 00:00:01.55]                           RolePermissions = {Cyclic reference to type DTOs.Entities.RolePermission detected}, 
[xUnit.net 00:00:01.55]                           Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       , 
[xUnit.net 00:00:01.55]                                                   Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]                           ,                     6 more
[xUnit.net 00:00:01.55]                           }, 
[xUnit.net 00:00:01.55]                           Tenant = <null>, 
[xUnit.net 00:00:01.55]                           TenantId = <null>, 
[xUnit.net 00:00:01.55]                           UpdatedAt = <2025-08-23 17:51:31.2150245>, 
[xUnit.net 00:00:01.55]                           UserRoles = {empty}
[xUnit.net 00:00:01.55]                       }, 
[xUnit.net 00:00:01.55]                       RoleId = 1, 
[xUnit.net 00:00:01.55]                       UpdatedAt = <2025-08-23 17:51:31.2397315>
[xUnit.net 00:00:01.55]                   }
[xUnit.net 00:00:01.55]               }, 
[xUnit.net 00:00:01.55]               UpdatedAt = <2025-08-23 17:51:31.1986516>
[xUnit.net 00:00:01.55]           }DTOs.Entities.Permission
[xUnit.net 00:00:01.55]           {
[xUnit.net 00:00:01.55]               Category = "Billing", 
[xUnit.net 00:00:01.55]               CreatedAt = <2025-08-23 17:51:31.1986516>, 
[xUnit.net 00:00:01.55]               Description = "Manage billing", 
[xUnit.net 00:00:01.55]               Id = 1, 
[xUnit.net 00:00:01.55]               IsActive = True, 
[xUnit.net 00:00:01.55]               Name = "billing.manage", 
[xUnit.net 00:00:01.55]               RolePermissions = DTOs.Entities.RolePermission
[xUnit.net 00:00:01.55]                   {
[xUnit.net 00:00:01.55]                       CreatedAt = <2025-08-23 17:51:31.2397315>, 
[xUnit.net 00:00:01.55]                       GrantedAt = <2025-08-23 17:51:31.2236468>, 
[xUnit.net 00:00:01.55]                       GrantedBy = "System", 
[xUnit.net 00:00:01.55]                       Id = 2, 
[xUnit.net 00:00:01.55]                       Permission = {Cyclic reference to type DTOs.Entities.Permission detected}, 
[xUnit.net 00:00:01.55]                       PermissionId = 1, 
[xUnit.net 00:00:01.55]                       Role = DTOs.Entities.Role
[xUnit.net 00:00:01.55]                       {
[xUnit.net 00:00:01.55]                           CreatedAt = <2025-08-23 17:51:31.2150245>, 
[xUnit.net 00:00:01.55]                           Description = "System super admin", 
[xUnit.net 00:00:01.55]                           Id = 1, 
[xUnit.net 00:00:01.55]                           IsActive = True, 
[xUnit.net 00:00:01.55]                           IsDefault = False, 
[xUnit.net 00:00:01.55]                           IsSystemRole = True, 
[xUnit.net 00:00:01.55]                           Name = "SuperAdmin", 
[xUnit.net 00:00:01.55]                           RolePermissions = 
[xUnit.net 00:00:01.55]                           Maximum recursion depth of 5 was reached.  Increase MaxDepth on AssertionScope or AssertionOptions to get more details.
[xUnit.net 00:00:01.55]       ,                     {Cyclic reference to type DTOs.Entities.RolePermission detected}
[xUnit.net 00:00:01.55]       
[xUnit.net 00:00:01.55]       (Output has exceeded the maximum of 100 lines. Increase FormattingOptions.MaxLines on AssertionScope or AssertionOptions to include more lines.)
[xUnit.net 00:00:01.55]       .
[xUnit.net 00:00:01.55]       Stack Trace:
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.55]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.55]            at FluentAssertions.Collections.GenericCollectionAssertions`3.HaveCount(Int32 expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.56]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Infrastructure\TestSetupVerificationTests.cs(37,0): at UserService.IntegrationTests.Infrastructure.TestSetupVerificationTests.TestSetup_ShouldCreateAllRequiredTestData()
[xUnit.net 00:00:01.56]         --- End of stack trace from previous location ---
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THS", "RequestPath": "/api/users/2/roles/1"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THR", "RequestPath": "/api/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THP", "RequestPath": "/api/roles/1"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI2", "RequestPath": "/api/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THQ", "RequestPath": "/api/users"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THU", "RequestPath": "/api/users/3/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI0", "RequestPath": "/api/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THT", "RequestPath": "/api/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI1", "RequestPath": "/api/tenants"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THV", "RequestPath": "/api/roles"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THT", "RequestPath": "/api/roles"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI1", "RequestPath": "/api/tenants"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THP", "RequestPath": "/api/roles/1"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THU", "RequestPath": "/api/users/3/roles"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI2", "RequestPath": "/api/roles"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THQ", "RequestPath": "/api/users"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THV", "RequestPath": "/api/roles"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI0", "RequestPath": "/api/roles"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THS", "RequestPath": "/api/users/2/roles/1"}
[12:51:31 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THR", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THQ", "RequestPath": "/api/users"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THV", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THT", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI2", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI0", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THU", "RequestPath": "/api/users/3/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI1", "RequestPath": "/api/tenants"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THS", "RequestPath": "/api/users/2/roles/1"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THP", "RequestPath": "/api/roles/1"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3THR", "RequestPath": "/api/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI1", "RequestPath": "/api/tenants"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THS", "RequestPath": "/api/users/2/roles/1"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THR", "RequestPath": "/api/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THT", "RequestPath": "/api/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI2", "RequestPath": "/api/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THQ", "RequestPath": "/api/users"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THP", "RequestPath": "/api/roles/1"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THU", "RequestPath": "/api/users/3/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TI0", "RequestPath": "/api/roles"}
[12:51:31 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3THV", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI4", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI3", "RequestPath": "/api/tenants"}
[xUnit.net 00:00:01.61]     UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.UserService_WithTenantToken_CanAccessUsers [FAIL]
[xUnit.net 00:00:01.61]       Expected HttpStatusCode to be successful (2xx) because UserService should accept valid tenant-aware JWT, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.61]       Stack Trace:
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.61]            at FluentAssertions.Primitives.HttpResponseMessageAssertions`1.BeSuccessful(String because, Object[] becauseArgs)
[xUnit.net 00:00:01.61]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TwoPhaseAuthTests.cs(87,0): at UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.UserService_WithTenantToken_CanAccessUsers()
[xUnit.net 00:00:01.61]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
?? Ensuring clean database state...
[xUnit.net 00:00:01.61]     UserService.IntegrationTests.Controllers.UsersControllerTests.RemoveRoleFromUser_WithValidData_ReturnsSuccess [FAIL]
[xUnit.net 00:00:01.61]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.61]       Stack Trace:
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI6", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.61]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.61]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(617,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.RemoveRoleFromUser_WithValidData_ReturnsSuccess()
[xUnit.net 00:00:01.61]         --- End of stack trace from previous location ---
? Database recreated with clean state
[xUnit.net 00:00:01.61]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithExcessivePageSize_ShouldReturnBadRequest [FAIL]
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Database recreated with clean state
[xUnit.net 00:00:01.61]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
? Database recreated with clean state
[xUnit.net 00:00:01.61]       Stack Trace:
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Database recreated with clean state
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Creating tenants...
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating tenants...
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating tenants...
[xUnit.net 00:00:01.61]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Creating tenants...
[xUnit.net 00:00:01.61]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(370,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithExcessivePageSize_ShouldReturnBadRequest()
[xUnit.net 00:00:01.61]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.61]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.SystemRoles_ShouldBeReadOnlyForTenantAdmins [FAIL]
[xUnit.net 00:00:01.61]       Expected viewResponse.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.61]       Stack Trace:
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.61]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.61]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(406,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.SystemRoles_ShouldBeReadOnlyForTenantAdmins()
[xUnit.net 00:00:01.61]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.61]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_RepeatedRequests_ShouldNotCauseMemoryLeaks [FAIL]
[xUnit.net 00:00:01.61]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.61]       Stack Trace:
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 2 tenants
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 2 tenants
[xUnit.net 00:00:01.61]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating permissions...
[xUnit.net 00:00:01.61]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Creating permissions...
[xUnit.net 00:00:01.61]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(207,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_RepeatedRequests_ShouldNotCauseMemoryLeaks()
[xUnit.net 00:00:01.61]         --- End of stack trace from previous location ---
?? Creating 38 permissions from actual business requirements
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - billing.manage (Billing)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
? Created 2 tenants
   - roles.delete (Roles)
? Created 2 tenants
?? Creating permissions...
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
?? Creating permissions...
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - billing.process_payments (Billing)
   - system.view_logs (System)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - system.view_metrics (System)
   - permissions.create (Permissions)
   - tenants.create (Tenants)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - tenants.delete (Tenants)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - reports.create (Reports)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - reports.export (Reports)
   - users.view_all (Users)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
? Created 2 tenants
?? Creating 38 permissions from actual business requirements
?? Creating permissions...
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - roles.edit (Roles)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI5", "RequestPath": "/api/tenants"}
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - permissions.create (Permissions)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - permissions.view (Permissions)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI8", "RequestPath": "/api/tenants"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI7", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant1.Id = 1
   - tenant2.Id = 2
   - tenant2.Id = 2
?? Roles to be created (8):
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TI9", "RequestPath": "/api/tenants"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIA", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIB", "RequestPath": "/api/tenants"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
? Created 8 roles
?? Creating role permissions...
?? Ensuring clean database state...
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.62]     UserService.IntegrationTests.Controllers.RolesControllerTests.DeleteRole_WithValidRole_ReturnsSuccess [FAIL]
? Successfully created all 8 roles including 2 Tenant 2 roles
? Created 8 roles
?? Creating role permissions...
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.62]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.62]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.62]       Stack Trace:
?? Ensuring clean database state...
[xUnit.net 00:00:01.62]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
? Successfully created all 8 roles including 2 Tenant 2 roles
[xUnit.net 00:00:01.62]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
?? Creating role permissions...
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.62]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(117,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.DeleteRole_WithValidRole_ReturnsSuccess()
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.62]         --- End of stack trace from previous location ---
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:01.62]         ----- Inner Stack Trace -----
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.62]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:01.62]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Assigned 6 permissions to Tenant1 Manager
[xUnit.net 00:00:01.62]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithInvalidPermissionNames_ShouldAcceptThem [FAIL]
?? Creating tenants...
? Assigned 3 permissions to Viewer
[xUnit.net 00:00:01.62]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
[xUnit.net 00:00:01.62]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
   - All roles count: 8
[xUnit.net 00:00:01.62]       Stack Trace:
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
[xUnit.net 00:00:01.62]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? ALL LOADED ROLES:
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
   - tenant2AdminRole found: True
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.62]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:01.62]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(126,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithInvalidPermissionNames_ShouldAcceptThem()
[xUnit.net 00:00:01.62]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.62]         ----- Inner Stack Trace -----
[xUnit.net 00:00:01.62]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.62]            at System.Text.Json.Utf8JsonReader.Read()
   - tenant2AdminRole.Id = 7
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.62]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - ID=8, Name='User', TenantId=2
? Database recreated with clean state
   - ID=7, Name='Admin', TenantId=2
?? TestDataSeeder: Starting test data seeding
? Assigned 3 permissions to Tenant2 User
?? Creating tenants...
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Created 8 roles
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
?? Verification - Created roles:
? Assigned 6 permissions to Tenant1 Manager
[xUnit.net 00:00:01.62]     UserService.IntegrationTests.Controllers.TenantsControllerTests.GetTenants_WithPagination_ShouldReturnPagedResults [FAIL]
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
? Assigned 3 permissions to Viewer
[xUnit.net 00:00:01.62]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
[xUnit.net 00:00:01.62]       Stack Trace:
   - All roles count: 8
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - Roles with TenantId = 2: 2
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.62]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:01.62]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - ID=1, Name='SuperAdmin', TenantId=
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
[xUnit.net 00:00:01.62]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(149,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.GetTenants_WithPagination_ShouldReturnPagedResults()
? Successfully created all 8 roles including 2 Tenant 2 roles
[xUnit.net 00:00:01.62]         --- End of stack trace from previous location ---
   - tenant2AdminRole found: True
?? Creating role permissions...
   - tenant2AdminRole.Id = 7
? Assigned 38 permissions to SuperAdmin
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 2 tenants
?? Creating permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
? Assigned 28 permissions to Tenant1 Admin
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
? Assigned 3 permissions to Tenant2 User
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
?? Ensuring clean database state...
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIC", "RequestPath": "/api/roles"}
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? CreateRoles DEBUG:
? Successfully created all 8 roles including 2 Tenant 2 roles
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Creating role permissions...
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TID", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIE", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIF", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIG", "RequestPath": "/api/roles"}
? All users created successfully
? All users created successfully
? Final user count: 7
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Adding 7 users to main context
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIH", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TII", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIJ", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Adding 7 users to main context
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIK", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIL", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIM", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIN", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIO", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIP", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIQ", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIR", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIS", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIT", "RequestPath": "/api/roles"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? MOCKING two-phase flow for admin@tenant2.com  Tenant 2
? Phase 1 simulated: User admin@tenant2.com authenticated (mocked)
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Phase 2 simulated: Tenant access verified for tenant 2
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Generated tenant-aware JWT for admin@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: Admin
   - Permissions: 28
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Two-phase flow simulation completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIU", "RequestPath": "/api/roles"}
?? Adding 7 users to main context
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ0", "RequestPath": "/api/roles"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TIV", "RequestPath": "/api/users"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ1", "RequestPath": "/api/roles"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[xUnit.net 00:00:01.68]     UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.TenantIsolation_Tenant2Admin_CannotSeeTenant1Users [FAIL]
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
?? Ensuring clean database state...
[xUnit.net 00:00:01.68]       Expected HttpStatusCode to be successful (2xx), but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.68]       Stack Trace:
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ2", "RequestPath": "/api/roles/assign"}
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.68]            at FluentAssertions.Primitives.HttpResponseMessageAssertions`1.BeSuccessful(String because, Object[] becauseArgs)
[xUnit.net 00:00:01.68]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TwoPhaseAuthTests.cs(132,0): at UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.TenantIsolation_Tenant2Admin_CannotSeeTenant1Users()
[xUnit.net 00:00:01.68]         --- End of stack trace from previous location ---
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ3", "RequestPath": "/api/roles"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ6", "RequestPath": "/api/users"}
[xUnit.net 00:00:01.68]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithEmptyName_ShouldReturnBadRequest [FAIL]
[xUnit.net 00:00:01.68]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Ensuring clean database state...
[xUnit.net 00:00:01.68]       Stack Trace:
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.68]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.68]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.68]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(41,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithEmptyName_ShouldReturnBadRequest()
[xUnit.net 00:00:01.68]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Ensuring clean database state...
? Created 2 tenants
?? Creating permissions...
? Created 38 permissions
?? Creating roles...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
? Database recreated with clean state
   - billing.process_payments (Billing)
?? TestDataSeeder: Starting test data seeding
   - billing.view (Billing)
?? Creating tenants...
   - billing.view_invoices (Billing)
?? CreateRoles DEBUG:
   - permissions.create (Permissions)
   - tenant1.Id = 1
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - tenant2.Id = 2
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
?? Roles to be created (8):
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   1. SuperAdmin (TenantId: )
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ4", "RequestPath": "/api/roles"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ7", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
?? Ensuring clean database state...
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Ensuring clean database state...
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ5", "RequestPath": "/api/users"}
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Created 2 tenants
?? Creating permissions...
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
? Created 2 tenants
?? Creating permissions...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
?? Creating 38 permissions from actual business requirements
   1. SuperAdmin (TenantId: )
   - billing.manage (Billing)
   2. Admin (TenantId: 1)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   3. User (TenantId: 1)
   - permissions.create (Permissions)
   4. Manager (TenantId: 1)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   5. Viewer (TenantId: 1)
   - permissions.manage (Permissions)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
? Created 8 roles
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - system.manage_backups (System)
   - system.manage_settings (System)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - system.monitor (System)
   - system.view_logs (System)
   - ID=5, Name='Viewer', TenantId=1
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - ID=4, Name='Manager', TenantId=1
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - ID=1, Name='SuperAdmin', TenantId=
   - tenants.view_all (Tenants)
? Successfully created all 8 roles including 2 Tenant 2 roles
   - users.create (Users)
?? Creating role permissions...
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.AssignRoleToUser_CrossTenantUser_ShouldFail [FAIL]
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
[xUnit.net 00:00:01.69]       Expected response.StatusCode to be HttpStatusCode.InternalServerError {value: 500}, but found HttpStatusCode.Unauthorized {value: 401}.
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
[xUnit.net 00:00:01.69]       Stack Trace:
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Created 38 permissions
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Created 38 permissions
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating roles...
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating roles...
[xUnit.net 00:00:01.69]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ8", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(177,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.AssignRoleToUser_CrossTenantUser_ShouldFail()
?? CreateRoles DEBUG:
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
   - tenant1.Id = 1
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_ConcurrentUpdates_ShouldHandleGracefully [FAIL]
   - tenant2.Id = 2
?? Roles to be created (8):
[xUnit.net 00:00:01.69]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:01.69]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
   2. Admin (TenantId: 1)
[xUnit.net 00:00:01.69]       Stack Trace:
   3. User (TenantId: 1)
[xUnit.net 00:00:01.69]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
   4. Manager (TenantId: 1)
?? CreateRoles DEBUG:
[xUnit.net 00:00:01.69]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   5. Viewer (TenantId: 1)
[xUnit.net 00:00:01.69]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
   6. Editor (TenantId: 1)
[xUnit.net 00:00:01.69]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
   7. Admin (TenantId: 2)
[xUnit.net 00:00:01.69]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
   - tenant1.Id = 1
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(428,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_ConcurrentUpdates_ShouldHandleGracefully()
   8. User (TenantId: 2)
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
   - tenant2.Id = 2
[xUnit.net 00:00:01.69]         ----- Inner Stack Trace -----
?? Roles to be created (8):
[xUnit.net 00:00:01.69]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:01.69]            at System.Text.Json.Utf8JsonReader.Read()
   2. Admin (TenantId: 1)
[xUnit.net 00:00:01.69]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.AssignRoles_ConcurrentAssignments_ShouldHandleRaceConditions [FAIL]
   5. Viewer (TenantId: 1)
[xUnit.net 00:00:01.69]       System.InvalidOperationException : Failed to create test user. Status: Unauthorized, Content: 
[xUnit.net 00:00:01.69]       Stack Trace:
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(360,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.CreateTestUserForLoadTesting()
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(86,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.AssignRoles_ConcurrentAssignments_ShouldHandleRaceConditions()
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.Controllers.RolesControllerTests.CreateRole_WithoutPermission_ReturnsForbidden [FAIL]
[xUnit.net 00:00:01.69]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.69]       Stack Trace:
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   6. Editor (TenantId: 1)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   7. Admin (TenantId: 2)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.69]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(526,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.CreateRole_WithoutPermission_ReturnsForbidden()
   8. User (TenantId: 2)
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
? Created 7 legacy tenant users
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_InvalidPageSize_ReturnsBadRequest [FAIL]
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.69]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[xUnit.net 00:00:01.69]       Stack Trace:
? Verified user: admin@tenant1.com (ID: 1)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Verified user: user@tenant1.com (ID: 2)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Verified user: admin@tenant2.com (ID: 6)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? admin@tenant1.com has 1 role assignments
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.69]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(507,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_InvalidPageSize_ReturnsBadRequest()
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 3 permissions to Tenant2 User
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.69]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_WithUserCounts_ShouldCompleteUnder500ms [FAIL]
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.69]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.69]       Stack Trace:
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.69]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Assigned 3 permissions to Viewer
[xUnit.net 00:00:01.69]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? TENANT 2 ADMIN DEBUG:
[xUnit.net 00:00:01.69]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(39,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_WithUserCounts_ShouldCompleteUnder500ms()
   - tenant2.Id = 2
   - All roles count: 8
[xUnit.net 00:00:01.69]         --- End of stack trace from previous location ---
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Ensuring clean database state...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 2 tenants
?? Generated tenant-aware JWT for user@tenant1.com:
?? Creating permissions...
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJ9", "RequestPath": "/api/tenants/1"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 38 permissions
?? Creating roles...
[xUnit.net 00:00:01.70]     UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(requiredPermission: "tenants.delete") [FAIL]
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
[xUnit.net 00:00:01.70]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:01.70]       Stack Trace:
   2. Admin (TenantId: 1)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   3. User (TenantId: 1)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   4. Manager (TenantId: 1)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   5. Viewer (TenantId: 1)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   6. Editor (TenantId: 1)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   7. Admin (TenantId: 2)
[xUnit.net 00:00:01.70]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   8. User (TenantId: 2)
[xUnit.net 00:00:01.70]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Ensuring clean database state...
[xUnit.net 00:00:01.70]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(362,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(String requiredPermission)
[xUnit.net 00:00:01.70]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? All users created successfully
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
? Final user count: 7
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Verified required user exists: admin@tenant1.com (ID:  1)
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
? Created 38 permissions
?? Creating roles...
?? Adding 8 user role assignments...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Adding 7 users to main context
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 8 user role assignments
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating legacy tenant users...
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? All users created successfully
? Final user count: 7
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Creating user role assignments...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Adding 7 users to main context
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? All users created successfully
?? Found 7 users and 8 roles for assignment
?? Adding 7 users to main context
?? Adding 8 user role assignments...
? Final user count: 7
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: admin@tenant1.com (ID:  1)
? admin@tenant1.com has 1 role assignments
? Created 109 role permissions using only actual business-defined permissions
? Verified required user exists: user@tenant1.com (ID:  2)
?? Creating users...
? TestDataSeeder: Test data seeding completed successfully
?? Adding 7 users to main context
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 1
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Two-phase flow simulation completed successfully
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? All users created successfully
? Final user count: 7
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJA", "RequestPath": "/api/roles/2/users/3"}
?? Found 7 users and 8 roles for assignment
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Adding 8 user role assignments...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 8 user role assignments...
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJB", "RequestPath": "/api/users"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Ensuring clean database state...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.73]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.RemoveRoleFromUser_ShouldLogRemovalDetails [FAIL]
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
[xUnit.net 00:00:01.73]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
[xUnit.net 00:00:01.73]       Stack Trace:
   - reports.create (Reports)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - reports.export (Reports)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - reports.schedule (Reports)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - reports.view (Reports)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - roles.assign_users (Roles)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.73]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.73]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(216,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.RemoveRoleFromUser_ShouldLogRemovalDetails()
[xUnit.net 00:00:01.73]         --- End of stack trace from previous location ---
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.73]     UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.TenantIsolation_Tenant1Admin_CannotSeeTenant2Users [FAIL]
[xUnit.net 00:00:01.73]       Expected HttpStatusCode to be successful (2xx), but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.73]       Stack Trace:
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.73]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.73]            at FluentAssertions.Primitives.HttpResponseMessageAssertions`1.BeSuccessful(String because, Object[] becauseArgs)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Ensuring clean database state...
? Created 8 user role assignments
[xUnit.net 00:00:01.73]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TwoPhaseAuthTests.cs(109,0): at UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.TenantIsolation_Tenant1Admin_CannotSeeTenant2Users()
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 user role assignments
[xUnit.net 00:00:01.73]         --- End of stack trace from previous location ---
?? Creating legacy tenant users...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 2 tenants
?? Creating permissions...
? Created 38 permissions
?? Creating roles...
?? Creating legacy tenant users...
? Verified user: admin@tenant2.com (ID: 6)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
?? CreateRoles DEBUG:
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - tenant1.Id = 1
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - tenant2.Id = 2
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
?? Roles to be created (8):
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   1. SuperAdmin (TenantId: )
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
? admin@tenant1.com has 1 role assignments
   4. Manager (TenantId: 1)
? TestDataSeeder: Test data seeding completed successfully
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   8. User (TenantId: 2)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Generated tenant-aware JWT for user@tenant1.com:
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJD", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJC", "RequestPath": "/api/roles/7/permissions"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJE", "RequestPath": "/api/roles/1/permissions"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.74]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.UpdateRolePermissions_WithNullPermissions_ShouldHandleGracefully [FAIL]
[xUnit.net 00:00:01.74]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJH", "RequestPath": "/api/tenants"}
[xUnit.net 00:00:01.74]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
?? Ensuring clean database state...
[xUnit.net 00:00:01.74]       Stack Trace:
[xUnit.net 00:00:01.74]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.74]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.74]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:01.74]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.74]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:01.74]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(235,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.UpdateRolePermissions_WithNullPermissions_ShouldHandleGracefully()
[xUnit.net 00:00:01.74]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.74]         ----- Inner Stack Trace -----
[xUnit.net 00:00:01.74]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:01.74]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:01.74]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Ensuring clean database state...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJF", "RequestPath": "/api/users/profile"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
? Created 7 legacy tenant users
   - permissions.view (Permissions)
   - reports.create (Reports)
?? Verifying test data...
?? Temporarily disabling query filters for verification...
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
? Created 2 tenants
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
?? Creating permissions...
   - users.view_all (Users)
?? Ensuring clean database state...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
[xUnit.net 00:00:01.74]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateRolePermissions_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
   - tenants.delete (Tenants)
[xUnit.net 00:00:01.74]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
   - tenants.edit (Tenants)
[xUnit.net 00:00:01.74]       Stack Trace:
   - tenants.initialize (Tenants)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - tenants.manage_settings (Tenants)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - tenants.view (Tenants)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - tenants.view_all (Tenants)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.74]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.74]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(110,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateRolePermissions_CrossTenantAttempt_ShouldReturnNotFound()
[xUnit.net 00:00:01.74]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.74]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithSystemRole_ShouldBeRejected [FAIL]
[xUnit.net 00:00:01.74]       Expected response.StatusCode to be HttpStatusCode.InternalServerError {value: 500}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.74]       Stack Trace:
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - users.create (Users)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - users.delete (Users)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - users.edit (Users)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - users.manage_roles (Users)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - users.view (Users)
[xUnit.net 00:00:01.74]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - users.view_all (Users)
[xUnit.net 00:00:01.74]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(34,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithSystemRole_ShouldBeRejected()
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[xUnit.net 00:00:01.74]         --- End of stack trace from previous location ---
? Verified user: admin@tenant1.com (ID: 1)
[xUnit.net 00:00:01.74]     UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(requiredPermission: "tenants.create") [FAIL]
[xUnit.net 00:00:01.74]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.74]       Stack Trace:
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Database recreated with clean state
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.74]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.74]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(362,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(String requiredPermission)
[xUnit.net 00:00:01.74]         --- End of stack trace from previous location ---
?? Creating tenants...
? Verified user: user@tenant1.com (ID: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified user: admin@tenant2.com (ID: 6)
?? Adding 7 users to main context
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Ensuring clean database state...
[xUnit.net 00:00:01.74]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserProfile_WithValidToken_ReturnsUserProfile [FAIL]
? Created 2 tenants
?? Creating permissions...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:01.74]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - billing.manage (Billing)
[xUnit.net 00:00:01.74]       Stack Trace:
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - billing.process_payments (Billing)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - billing.view (Billing)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:01.74]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - permissions.create (Permissions)
[xUnit.net 00:00:01.74]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - permissions.delete (Permissions)
[xUnit.net 00:00:01.74]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(35,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserProfile_WithValidToken_ReturnsUserProfile()
   - permissions.edit (Permissions)
[xUnit.net 00:00:01.74]         --- End of stack trace from previous location ---
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
   - system.view_metrics (System)
?? Creating tenants...
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJG", "RequestPath": "/api/roles"}
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Ensuring clean database state...
? Created 38 permissions
?? Creating roles...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJI", "RequestPath": "/api/roles"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
? Created 2 tenants
?? Creating permissions...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
?? Ensuring clean database state...
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 8 roles
? Created 8 roles
?? Verification - Created roles:
?? Verification - Created roles:
? All users created successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - ID=8, Name='User', TenantId=2
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=5, Name='Viewer', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=3, Name='User', TenantId=1
? Created 2 tenants
? Successfully created all 8 roles including 2 Tenant 2 roles
   - ID=2, Name='Admin', TenantId=1
?? Creating permissions...
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.75]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithUserToken_ReturnsSuccess [FAIL]
?? Creating role permissions...
? Final user count: 7
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.75]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.75]       Stack Trace:
   - ID=4, Name='Manager', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Assigned 38 permissions to SuperAdmin
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
[xUnit.net 00:00:01.75]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
[xUnit.net 00:00:01.75]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(501,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithUserToken_ReturnsSuccess()
? Assigned 3 permissions to Tenant1 User
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:01.75]         --- End of stack trace from previous location ---
?? All users created and verified successfully!
? Assigned 6 permissions to Tenant1 Manager
?? Creating user role assignments...
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - Roles with TenantId = 2: 2
? Assigned 3 permissions to Tenant2 User
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Created 8 roles
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
?? Verification - Created roles:
? Assigned 3 permissions to Tenant1 User
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
? Assigned 6 permissions to Tenant1 Manager
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - ID=2, Name='Admin', TenantId=1
   - tenant2.Id = 2
   - All roles count: 8
   - ID=1, Name='SuperAdmin', TenantId=
   - Roles with TenantId = 2: 2
? Successfully created all 8 roles including 2 Tenant 2 roles
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
?? Creating role permissions...
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Found 7 users and 8 roles for assignment
?? Creating roles...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - billing.process_payments (Billing)
   - Tenant: Test Tenant 1 (ID: 1)
   - billing.view (Billing)
   - Roles: Admin
   - billing.view_invoices (Billing)
   - Permissions: 28
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - ID=8, Name='User', TenantId=2
?? CreateRoles DEBUG:
   - ID=7, Name='Admin', TenantId=2
   - tenant1.Id = 1
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - tenant2.Id = 2
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
?? Adding 8 user role assignments...
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
[xUnit.net 00:00:01.75]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_WithPagination_ShouldScaleLinearly [FAIL]
   - system.view_metrics (System)
   - tenants.create (Tenants)
[xUnit.net 00:00:01.75]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
[xUnit.net 00:00:01.75]       Stack Trace:
   - tenants.initialize (Tenants)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - tenants.manage_settings (Tenants)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - users.create (Users)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - users.delete (Users)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - users.edit (Users)
[xUnit.net 00:00:01.75]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - users.manage_roles (Users)
[xUnit.net 00:00:01.75]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - users.view (Users)
   - users.view_all (Users)
[xUnit.net 00:00:01.75]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(136,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_WithPagination_ShouldScaleLinearly()
[xUnit.net 00:00:01.75]         --- End of stack trace from previous location ---
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
? Created 8 roles
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJJ", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
? Created 38 permissions
?? Creating roles...
?? Adding 8 user role assignments...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJK", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Created 8 user role assignments
?? Creating legacy tenant users...
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJL", "RequestPath": "/api/roles"}
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Creating users...
?? Adding 7 users to main context
?? Adding 7 users to main context
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJM", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJN", "RequestPath": "/api/roles"}
? All users created successfully
? Created 109 role permissions using only actual business-defined permissions
? Verified user: user@tenant1.com (ID: 2)
?? Creating users...
? Final user count: 7
?? Adding 7 users to main context
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified user: admin@tenant1.com (ID: 1)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? Found 7 users and 8 roles for assignment
? Final user count: 7
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Adding 7 users to main context
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? MOCKING two-phase flow for admin@tenant1.com  Tenant 1
? Phase 1 simulated: User admin@tenant1.com authenticated (mocked)
? Phase 2 simulated: Tenant access verified for tenant 1
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Two-phase flow simulation completed successfully
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJO", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJP", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.77]     UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.Roles_TenantSpecific_ShouldBeIsolated [FAIL]
? Created 8 user role assignments
?? Creating legacy tenant users...
[xUnit.net 00:00:01.77]       Expected HttpStatusCode to be successful (2xx), but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.77]       Stack Trace:
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.77]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.77]            at FluentAssertions.Primitives.HttpResponseMessageAssertions`1.BeSuccessful(String because, Object[] becauseArgs)
[xUnit.net 00:00:01.77]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TwoPhaseAuthTests.cs(155,0): at UserService.IntegrationTests.Controllers.TwoPhaseAuthTests.Roles_TenantSpecific_ShouldBeIsolated()
[xUnit.net 00:00:01.77]         --- End of stack trace from previous location ---
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 8 user role assignments
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Creating legacy tenant users...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJR", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJQ", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJS", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UnauthorizedRoleAccess_ShouldLogSecurityEvents [FAIL]
[xUnit.net 00:00:01.78]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]       Stack Trace:
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.78]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.78]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(301,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UnauthorizedRoleAccess_ShouldLogSecurityEvents()
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.78]         --- End of stack trace from previous location ---
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJT", "RequestPath": "/api/roles"}
?? Ensuring clean database state...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
? Verified user: admin@tenant2.com (ID: 6)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJU", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for user@tenant1.com:
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Creating legacy tenant users...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Created 38 permissions
?? Creating roles...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK0", "RequestPath": "/api/roles/0"}
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TJV", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK1", "RequestPath": "/api/users/6"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK3", "RequestPath": "/api/users"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK2", "RequestPath": "/api/tenants/1"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRole_WithZeroId_ShouldReturnNotFound [FAIL]
?? Temporarily disabling query filters for verification...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.79]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.79]       Stack Trace:
?? Ensuring clean database state...
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Verified user: admin@tenant1.com (ID: 1)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: user@tenant1.com (ID: 2)
? Database recreated with clean state
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant1.com (ID: 1)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Verified user: admin@tenant2.com (ID: 6)
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(297,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRole_WithZeroId_ShouldReturnNotFound()
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUser_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
   - users.view (Users)
[xUnit.net 00:00:01.79]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
   - users.view_all (Users)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]       Stack Trace:
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Ensuring clean database state...
?? Ensuring clean database state...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Ensuring clean database state...
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.79]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(261,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUser_CrossTenantAttempt_ShouldReturnNotFound()
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Database recreated with clean state
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(requiredPermission: "tenants.edit") [FAIL]
? Created 2 tenants
[xUnit.net 00:00:01.79]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Creating permissions...
[xUnit.net 00:00:01.79]       Stack Trace:
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - billing.manage (Billing)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 2 tenants
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
[xUnit.net 00:00:01.79]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(362,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(String requiredPermission)
   - system.monitor (System)
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK4", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? Generated tenant-aware JWT for user@tenant1.com:
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithUserRole_ReturnsForbidden [FAIL]
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.79]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
   - Roles: User
   - Permissions: 3
[xUnit.net 00:00:01.79]       Stack Trace:
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? CreateRoles DEBUG:
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - tenant1.Id = 1
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - tenant2.Id = 2
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Roles to be created (8):
[xUnit.net 00:00:01.79]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(525,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithUserRole_ReturnsForbidden()
   2. Admin (TenantId: 1)
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK6", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK5", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
? Created 38 permissions
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Creating roles...
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK7", "RequestPath": "/api/roles"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRole_WithValidData_ReturnsUpdatedRole [FAIL]
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[xUnit.net 00:00:01.79]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK8", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.79]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.79]       Stack Trace:
[xUnit.net 00:00:01.79]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.79]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.79]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.79]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.79]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(82,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRole_WithValidData_ReturnsUpdatedRole()
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
? Created 38 permissions
?? Creating roles...
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
?? Ensuring clean database state...
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:01.79]         ----- Inner Stack Trace -----
?? Ensuring clean database state...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
[xUnit.net 00:00:01.79]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
   6. Editor (TenantId: 1)
[xUnit.net 00:00:01.79]            at System.Text.Json.Utf8JsonReader.Read()
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:01.79]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.79]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_MultipleConsecutiveRequests_ShouldMaintainPerformance [FAIL]
[xUnit.net 00:00:01.79]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
? Created 2 tenants
[xUnit.net 00:00:01.79]       Stack Trace:
?? Creating permissions...
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Created 2 tenants
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Creating permissions...
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:01.79]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - billing.manage (Billing)
[xUnit.net 00:00:01.79]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - billing.process_payments (Billing)
[xUnit.net 00:00:01.79]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(71,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoles_MultipleConsecutiveRequests_ShouldMaintainPerformance()
   - billing.view (Billing)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:01.79]         --- End of stack trace from previous location ---
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
?? Creating 38 permissions from actual business requirements
   - roles.edit (Roles)
   - billing.manage (Billing)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - billing.process_payments (Billing)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - billing.view (Billing)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - billing.view_invoices (Billing)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TK9", "RequestPath": "/api/roles"}
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - permissions.create (Permissions)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - users.manage_roles (Users)
   - permissions.manage (Permissions)
   - users.view (Users)
   - permissions.view (Permissions)
   - users.view_all (Users)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
? Created 8 roles
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:01.80]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.GetRolePermissions_WithoutViewPermission_ShouldReturnForbidden [FAIL]
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
[xUnit.net 00:00:01.80]       Expected rolesResponse.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.80]       Stack Trace:
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.80]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.80]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.80]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(399,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.GetRolePermissions_WithoutViewPermission_ShouldReturnForbidden()
[xUnit.net 00:00:01.80]         --- End of stack trace from previous location ---
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
? Assigned 28 permissions to Tenant1 Admin
?? Creating role permissions...
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Ensuring clean database state...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Assigned 6 permissions to Tenant1 Manager
?? Creating tenants...
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKA", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKB", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 38 permissions
?? Creating roles...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKC", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKD", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKE", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKF", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKG", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKH", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKI", "RequestPath": "/api/roles"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? All users created successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKJ", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKK", "RequestPath": "/api/roles"}
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKM", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKL", "RequestPath": "/api/users"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 WRN] Could not get Tenant 2 roles for audit test. Status: Unauthorized {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[xUnit.net 00:00:01.82]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.AssignRoles_BulkAssignments_ShouldCompleteWithinReasonableTime [FAIL]
? All users created successfully
?? Ensuring clean database state...
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[xUnit.net 00:00:01.82]       System.InvalidOperationException : Failed to create test user. Status: Unauthorized, Content: 
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:01.82]       Stack Trace:
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:01.82]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(360,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.CreateTestUserForLoadTesting()
?? All users created and verified successfully!
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating user role assignments...
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.82]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(35,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.AssignRoles_BulkAssignments_ShouldCompleteWithinReasonableTime()
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:01.82]         --- End of stack trace from previous location ---
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKN", "RequestPath": "/api/roles/7"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.83]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.CrossTenantAccess_ShouldLogSecurityViolations [FAIL]
[xUnit.net 00:00:01.83]       Expected fallbackResponse.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.83]       Stack Trace:
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Ensuring clean database state...
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.83]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.83]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(334,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.CrossTenantAccess_ShouldLogSecurityViolations()
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.83]         --- End of stack trace from previous location ---
? Created 38 permissions
?? Creating roles...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 2 tenants
?? Creating permissions...
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
? Verified user: admin@tenant1.com (ID: 1)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKO", "RequestPath": "/api/roles"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKP", "RequestPath": "/api/tenants"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 8 roles
?? Verification - Created roles:
? Verified user: admin@tenant2.com (ID: 6)
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
? Created 8 roles
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 3 permissions to Tenant2 User
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 38 permissions to SuperAdmin
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.83]     UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(requiredPermission: "tenants.view") [FAIL]
[xUnit.net 00:00:01.83]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.83]       Stack Trace:
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Created 7 legacy tenant users
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Verifying test data...
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.83]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.83]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.83]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(362,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.TenantEndpoints_WithoutPermission_ShouldReturn403(String requiredPermission)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKQ", "RequestPath": "/api/users"}
[xUnit.net 00:00:01.83]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithAdminRole_ReturnsSuccess [FAIL]
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.84]       Stack Trace:
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Ensuring clean database state...
[xUnit.net 00:00:01.84]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.84]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(558,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithAdminRole_ReturnsSuccess()
[xUnit.net 00:00:01.84]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
[xUnit.net 00:00:01.84]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithMissingContentType_ShouldReturnBadRequest [FAIL]
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.84]       Expected response.StatusCode to be one of {HttpStatusCode.BadRequest {value: 400}, HttpStatusCode.UnsupportedMediaType {value: 415}}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]       Stack Trace:
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Database recreated with clean state
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.84]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating tenants...
[xUnit.net 00:00:01.84]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.84]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(505,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithMissingContentType_ShouldReturnBadRequest()
[xUnit.net 00:00:01.84]         --- End of stack trace from previous location ---
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating 38 permissions from actual business requirements
?? Creating permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - Permissions: 28
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKR", "RequestPath": "/api/roles/2/users"}
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
? Assigned 3 permissions to Tenant2 User
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Created 8 roles
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Roles: Admin
   - Permissions: 28
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKS", "RequestPath": "/api/roles/assign"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
?? Adding 7 users to main context
   - Permissions: 28
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.85]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.AssignRoleToUser_CrossTenantRole_ShouldFail [FAIL]
[xUnit.net 00:00:01.85]       Expected response.StatusCode to be HttpStatusCode.InternalServerError {value: 500}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.85]       Stack Trace:
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.85]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.85]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(154,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.AssignRoleToUser_CrossTenantRole_ShouldFail()
[xUnit.net 00:00:01.85]         --- End of stack trace from previous location ---
?? ALL LOADED ROLES:
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKU", "RequestPath": "/api/roles/2/users"}
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
? Created 109 role permissions using only actual business-defined permissions
   - ID=2, Name='Admin', TenantId=1
?? Creating users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Adding 7 users to main context
?? Ensuring clean database state...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKV", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL1", "RequestPath": "/api/roles/2/users"}
   - ID=1, Name='SuperAdmin', TenantId=
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 WRN] Could not get Tenant 2 roles. Response: Unauthorized {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
?? Generated tenant-aware JWT for admin@tenant1.com:
? Assigned 3 permissions to Tenant1 User
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL0", "RequestPath": "/api/roles"}
? Created 2 tenants
?? Creating permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL2", "RequestPath": "/api/roles/2/users"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Final user count: 7
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL3", "RequestPath": "/api/roles/7/permissions"}
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TKT", "RequestPath": "/api/roles/2/users"}
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL4", "RequestPath": "/api/roles/2/users"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[xUnit.net 00:00:01.85]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithLargePermissionSet_ShouldSucceed [FAIL]
[xUnit.net 00:00:01.85]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
?? Ensuring clean database state...
[xUnit.net 00:00:01.85]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.85]       Stack Trace:
[xUnit.net 00:00:01.85]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:01.85]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.85]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:01.85]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.85]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:01.85]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(170,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithLargePermissionSet_ShouldSucceed()
[xUnit.net 00:00:01.85]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.85]         ----- Inner Stack Trace -----
[xUnit.net 00:00:01.85]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:01.85]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:01.85]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL5", "RequestPath": "/api/roles/2/users"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.85]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_CrossTenantAttempt_ReturnsNotFound [FAIL]
[xUnit.net 00:00:01.85]       Expected response.StatusCode to be one of {HttpStatusCode.NotFound {value: 404}, HttpStatusCode.InternalServerError {value: 500}}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.85]       Stack Trace:
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Created 2 tenants
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Ensuring clean database state...
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating permissions...
[xUnit.net 00:00:01.85]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Created 38 permissions
[xUnit.net 00:00:01.85]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
?? Creating roles...
[xUnit.net 00:00:01.85]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
[xUnit.net 00:00:01.85]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(460,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_CrossTenantAttempt_ReturnsNotFound()
[xUnit.net 00:00:01.85]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
?? Creating 38 permissions from actual business requirements
   5. Viewer (TenantId: 1)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   6. Editor (TenantId: 1)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   7. Admin (TenantId: 2)
   - roles.view (Roles)
   8. User (TenantId: 2)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL6", "RequestPath": "/api/roles/2/users"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Final user count: 7
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL7", "RequestPath": "/api/roles/2/users"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL8", "RequestPath": "/api/roles/2/users"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Created 8 user role assignments
?? Creating legacy tenant users...
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TL9", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
[xUnit.net 00:00:01.87]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.DeleteRole_ShouldLogDeletionWithDetails [FAIL]
? Final user count: 7
[xUnit.net 00:00:01.87]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.87]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.87]       Stack Trace:
? Verified required user exists: admin@tenant1.com (ID:  1)
[xUnit.net 00:00:01.87]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.87]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.87]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:01.87]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.87]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:01.87]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(131,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.DeleteRole_ShouldLogDeletionWithDetails()
[xUnit.net 00:00:01.87]         --- End of stack trace from previous location ---
? Verified required user exists: user@tenant1.com (ID:  2)
[xUnit.net 00:00:01.87]         ----- Inner Stack Trace -----
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:01.87]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:01.87]            at System.Text.Json.Utf8JsonReader.Read()
?? All users created and verified successfully!
[xUnit.net 00:00:01.87]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Creating user role assignments...
?? Ensuring clean database state...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? All users created successfully
? Final user count: 7
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified user: admin@tenant1.com (ID: 1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLA", "RequestPath": "/api/roles"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified user: user@tenant1.com (ID: 2)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
? Created 7 legacy tenant users
   - Tenant: Test Tenant 1 (ID: 1)
?? Verifying test data...
?? Temporarily disabling query filters for verification...
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? All users created successfully
? Verified user: user@tenant1.com (ID: 2)
? Final user count: 7
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
?? Roles to be created (8):
   - Permissions: 28
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLB", "RequestPath": "/api/users/1/roles"}
?? Ensuring clean database state...
[xUnit.net 00:00:01.88]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoleUsers_ConcurrentRequests_ShouldHandleLoadEfficiently [FAIL]
[xUnit.net 00:00:01.88]       Expected results to contain only items satisfying the inspector:
[xUnit.net 00:00:01.88]       	At index 0:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
[xUnit.net 00:00:01.88]       	At index 1:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
[xUnit.net 00:00:01.88]       	At index 2:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
? Database recreated with clean state
[xUnit.net 00:00:01.88]       	At index 3:
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
?? Creating tenants...
? Created 8 roles
[xUnit.net 00:00:01.88]       	At index 4:
? Created 7 legacy tenant users
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
?? Verifying test data...
[xUnit.net 00:00:01.88]       	At index 5:
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
?? Verification - Created roles:
[xUnit.net 00:00:01.88]       	At index 6:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
[xUnit.net 00:00:01.88]       	At index 7:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.88]       	At index 8:
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
[xUnit.net 00:00:01.88]       	At index 9:
[xUnit.net 00:00:01.88]       		Expected result.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}
[xUnit.net 00:00:01.88]       Stack Trace:
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.AssertionScope.FailWithPreFormatted(String formattedFailReason)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.88]            at FluentAssertions.Collections.GenericCollectionAssertions`3.AllSatisfy(Action`1 expected, String because, Object[] becauseArgs)
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.88]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(254,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoleUsers_ConcurrentRequests_ShouldHandleLoadEfficiently()
[xUnit.net 00:00:01.88]         --- End of stack trace from previous location ---
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Verified user: admin@tenant1.com (ID: 1)
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
? Created 2 tenants
? Verified user: user@tenant1.com (ID: 2)
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
?? Creating permissions...
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLC", "RequestPath": "/api/roles"}
?? Creating 38 permissions from actual business requirements
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLD", "RequestPath": "/api/tenants"}
? admin@tenant1.com has 1 role assignments
   - billing.manage (Billing)
? TestDataSeeder: Test data seeding completed successfully
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
? Created 8 user role assignments
   - tenants.view (Tenants)
?? Creating legacy tenant users...
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLF", "RequestPath": "/api/users/profile"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLG", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.88]     UserService.IntegrationTests.Controllers.UsersControllerTests.UpdateUserProfile_WithInvalidData_ReturnsBadRequest [FAIL]
[xUnit.net 00:00:01.88]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.88]       Stack Trace:
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.88]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.88]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Ensuring clean database state...
[xUnit.net 00:00:01.88]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(102,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.UpdateUserProfile_WithInvalidData_ReturnsBadRequest()
[xUnit.net 00:00:01.88]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 38 permissions
?? Creating roles...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
?? Generated tenant-aware JWT for admin@tenant1.com:
   8. User (TenantId: 2)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 2 tenants
?? Creating permissions...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
?? Creating 38 permissions from actual business requirements
? Verified user: admin@tenant2.com (ID: 6)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLE", "RequestPath": "/api/roles/2/permissions"}
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.89]     UserService.IntegrationTests.Controllers.TenantsControllerTests.UpdateTenant_WithValidData_ShouldUpdateTenant [FAIL]
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Ensuring clean database state...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.89]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.89]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.89]       Stack Trace:
[xUnit.net 00:00:01.89]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.89]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.89]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:01.89]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.89]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
? Created 7 legacy tenant users
[xUnit.net 00:00:01.89]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(183,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.UpdateTenant_WithValidData_ShouldUpdateTenant()
?? Verifying test data...
[xUnit.net 00:00:01.89]         --- End of stack trace from previous location ---
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.89]         ----- Inner Stack Trace -----
? Created 2 tenants
[xUnit.net 00:00:01.89]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
?? Creating permissions...
[xUnit.net 00:00:01.89]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:01.89]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLI", "RequestPath": "/api/roles"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 roles
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLH", "RequestPath": "/api/users/1/roles"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating roles...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Roles to be created (8):
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLK", "RequestPath": "/api/roles"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
? Assigned 6 permissions to Tenant1 Manager
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLJ", "RequestPath": "/api/roles/2/permissions"}
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Roles with TenantId = 2: 2
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - Permissions: 28
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLL", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.90]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithMalformedJson_ShouldReturnBadRequest [FAIL]
[xUnit.net 00:00:01.90]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.90]       Stack Trace:
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLM", "RequestPath": "/api/users/1/roles"}
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Ensuring clean database state...
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.90]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.90]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(183,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithMalformedJson_ShouldReturnBadRequest()
[xUnit.net 00:00:01.90]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 2 tenants
?? Creating permissions...
? Created 8 roles
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
?? Verification - Created roles:
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - ID=8, Name='User', TenantId=2
   - permissions.view (Permissions)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - reports.create (Reports)
   - ID=4, Name='Manager', TenantId=1
   - reports.export (Reports)
   - reports.schedule (Reports)
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - reports.view (Reports)
? Successfully created all 8 roles including 2 Tenant 2 roles
   - roles.assign_users (Roles)
?? Creating role permissions...
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=8, Name='User', TenantId=2
? Successfully created all 8 roles including 2 Tenant 2 roles
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - ID=2, Name='Admin', TenantId=1
   - Tenant: Test Tenant 1 (ID: 1)
   - ID=1, Name='SuperAdmin', TenantId=
   - Roles: Admin
   - Permissions: 28
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLO", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Creating roles...
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLN", "RequestPath": "/api/roles/2/permissions"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLP", "RequestPath": "/api/roles/2/permissions"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLR", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLQ", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLS", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:01.90]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithValidRole_ReturnsPermissions [FAIL]
[xUnit.net 00:00:01.90]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.90]       Stack Trace:
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.90]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - Roles: Admin
[xUnit.net 00:00:01.90]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - Permissions: 28
[xUnit.net 00:00:01.90]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(190,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithValidRole_ReturnsPermissions()
[xUnit.net 00:00:01.90]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.90]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRole_ShouldUpdatePermissions_WhenSpecified [FAIL]
[xUnit.net 00:00:01.90]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.90]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.90]       Stack Trace:
[xUnit.net 00:00:01.90]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.90]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.90]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
? Created 2 tenants
[xUnit.net 00:00:01.90]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLV", "RequestPath": "/api/roles"}
[xUnit.net 00:00:01.90]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
?? Creating permissions...
?? Ensuring clean database state...
[xUnit.net 00:00:01.90]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(323,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRole_ShouldUpdatePermissions_WhenSpecified()
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:01.90]         --- End of stack trace from previous location ---
   - billing.manage (Billing)
[xUnit.net 00:00:01.90]         ----- Inner Stack Trace -----
   - billing.process_payments (Billing)
   - billing.view (Billing)
[xUnit.net 00:00:01.90]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:01.90]            at System.Text.Json.Utf8JsonReader.Read()
   - permissions.create (Permissions)
[xUnit.net 00:00:01.90]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
   - system.manage_backups (System)
   - system.manage_settings (System)
?? Creating tenants...
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM0", "RequestPath": "/api/roles/2/permissions"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Created 2 tenants
?? Creating permissions...
? Final user count: 7
?? Creating 38 permissions from actual business requirements
? Verified required user exists: admin@tenant1.com (ID:  1)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
? Verified required user exists: user@tenant1.com (ID:  2)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLU", "RequestPath": "/api/users"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TLT", "RequestPath": "/api/users/1/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM1", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM2", "RequestPath": "/api/users/1/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM3", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM4", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM5", "RequestPath": "/api/roles/2/permissions"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM6", "RequestPath": "/api/users"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Created 8 roles
? Created 8 roles
?? Adding 7 users to main context
?? Verification - Created roles:
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=8, Name='User', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=3, Name='User', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 38 permissions to SuperAdmin
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
? Created 8 user role assignments
? Assigned 28 permissions to Tenant1 Admin
?? Creating legacy tenant users...
? Assigned 3 permissions to Tenant1 User
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
? Assigned 3 permissions to Tenant2 User
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Final user count: 7
?? Adding 7 users to main context
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM8", "RequestPath": "/api/users/1/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM7", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? All users created successfully
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TM9", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMB", "RequestPath": "/api/roles"}
? Final user count: 7
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMA", "RequestPath": "/api/roles/2/permissions"}
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Found 7 users and 8 roles for assignment
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMD", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Generated tenant-aware JWT for admin@tenant1.com:
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMC", "RequestPath": "/api/users/1/roles"}
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
[xUnit.net 00:00:01.92]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.TenantIsolation_DifferentTenantsCannotSeeEachOthersData [FAIL]
? Verified user: admin@tenant2.com (ID: 6)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.92]       Expected tenant1RolesResponse.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.92]       Stack Trace:
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Ensuring clean database state...
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.92]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.92]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.92]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(371,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.TenantIsolation_DifferentTenantsCannotSeeEachOthersData()
[xUnit.net 00:00:01.92]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMG", "RequestPath": "/api/users/1/roles"}
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMH", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TME", "RequestPath": "/api/roles/2/permissions"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMF", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMI", "RequestPath": "/api/roles/2/permissions"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 38 permissions
?? Creating roles...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMJ", "RequestPath": "/api/roles"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMK", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TML", "RequestPath": "/api/users/1/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMM", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMO", "RequestPath": "/api/roles"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Ensuring clean database state...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
[xUnit.net 00:00:01.93]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UpdateRole_ShouldLogPermissionChanges [FAIL]
? Final user count: 7
[xUnit.net 00:00:01.93]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.93]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.93]       Stack Trace:
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.93]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
? Verified required user exists: admin@tenant1.com (ID:  1)
[xUnit.net 00:00:01.93]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.93]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
? Verified required user exists: user@tenant1.com (ID:  2)
[xUnit.net 00:00:01.93]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.93]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
?? Generated tenant-aware JWT for admin@tenant1.com:
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:01.93]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(81,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UpdateRole_ShouldLogPermissionChanges()
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.93]         --- End of stack trace from previous location ---
   - Roles: Admin
[xUnit.net 00:00:01.93]         ----- Inner Stack Trace -----
   - Permissions: 28
[xUnit.net 00:00:01.93]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:01.93]            at System.Text.Json.Utf8JsonReader.Read()
?? All users created and verified successfully!
[xUnit.net 00:00:01.93]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Adding 8 user role assignments...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMN", "RequestPath": "/api/roles/2/permissions"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMP", "RequestPath": "/api/users/1/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMQ", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMR", "RequestPath": "/api/roles/2/permissions"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Created 7 legacy tenant users
? Assigned 38 permissions to SuperAdmin
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
? Created 109 role permissions using only actual business-defined permissions
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMS", "RequestPath": "/api/roles"}
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Creating users...
? Verified user: admin@tenant1.com (ID: 1)
?? Adding 7 users to main context
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMT", "RequestPath": "/api/users/1/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMU", "RequestPath": "/api/users"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TMV", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN0", "RequestPath": "/api/tenants"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN1", "RequestPath": "/api/roles/2/permissions"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.94]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithSearchTerm_ReturnsFilteredResults [FAIL]
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.94]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Ensuring clean database state...
[xUnit.net 00:00:01.94]       Stack Trace:
? Created 7 legacy tenant users
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.94]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.94]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.94]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(218,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithSearchTerm_ReturnsFilteredResults()
[xUnit.net 00:00:01.94]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.94]     UserService.IntegrationTests.Controllers.TenantsControllerTests.DeleteTenant_WithUsers_ShouldReturnError [FAIL]
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.94]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
?? Ensuring clean database state...
[xUnit.net 00:00:01.94]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:01.94]       Stack Trace:
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:01.94]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.94]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.94]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:01.94]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:01.94]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:01.94]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(232,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.DeleteTenant_WithUsers_ShouldReturnError()
[xUnit.net 00:00:01.94]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.94]         ----- Inner Stack Trace -----
[xUnit.net 00:00:01.94]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:01.94]            at System.Text.Json.Utf8JsonReader.Read()
   - Roles: Admin
[xUnit.net 00:00:01.94]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - Permissions: 28
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN2", "RequestPath": "/api/roles"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 2 tenants
?? Creating permissions...
? Verified user: admin@tenant2.com (ID: 6)
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
?? Creating 38 permissions from actual business requirements
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - billing.manage (Billing)
   - reports.view (Reports)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
? admin@tenant1.com has 1 role assignments
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - permissions.create (Permissions)
   - system.manage_backups (System)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - system.manage_settings (System)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - system.monitor (System)
   - roles.assign_users (Roles)
   - roles.create (Roles)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
? TestDataSeeder: Test data seeding completed successfully
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - system.view_logs (System)
   - tenants.delete (Tenants)
   - system.view_metrics (System)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.create (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.delete (Tenants)
   - tenants.view (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view_all (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.create (Users)
   - users.view (Users)
   - users.view_all (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN3", "RequestPath": "/api/roles"}
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN6", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN4", "RequestPath": "/api/users/1/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN5", "RequestPath": "/api/users"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN7", "RequestPath": "/api/roles/2/permissions"}
? Created 38 permissions
?? Creating roles...
? Verified user: admin@tenant1.com (ID: 1)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
? Verified user: user@tenant1.com (ID: 2)
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified user: admin@tenant2.com (ID: 6)
? All users created successfully
? Final user count: 7
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 38 permissions
?? Creating roles...
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Creating user role assignments...
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.95]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithExtremelyLongName_ShouldReturnBadRequest [FAIL]
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
[xUnit.net 00:00:01.95]       Expected response.StatusCode to be one of {HttpStatusCode.BadRequest {value: 400}, HttpStatusCode.InternalServerError {value: 500}}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Verification - Created roles:
[xUnit.net 00:00:01.95]       Stack Trace:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:01.95]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.95]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
? Successfully created all 8 roles including 2 Tenant 2 roles
[xUnit.net 00:00:01.95]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(84,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithExtremelyLongName_ShouldReturnBadRequest()
?? Creating role permissions...
[xUnit.net 00:00:01.95]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNA", "RequestPath": "/api/roles"}
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNB", "RequestPath": "/api/users/1/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN9", "RequestPath": "/api/roles"}
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TN8", "RequestPath": "/api/users"}
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:01.95]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.CreateRole_WithNoPermissions_ShouldSucceed [FAIL]
? Created 38 permissions
?? Creating roles...
?? Ensuring clean database state...
[xUnit.net 00:00:01.95]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.95]       Stack Trace:
?? CreateRoles DEBUG:
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   5. Viewer (TenantId: 1)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.95]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.95]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(256,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.CreateRole_WithNoPermissions_ShouldSucceed()
   8. User (TenantId: 2)
[xUnit.net 00:00:01.95]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 2 tenants
?? Creating permissions...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
?? Creating user role assignments...
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
? Created 8 user role assignments
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
?? Creating legacy tenant users...
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Ensuring clean database state...
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:01.95]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.RoleAssignmentSystem_UnderStress_ShouldRemainStable [FAIL]
?? Adding 8 user role assignments...
[xUnit.net 00:00:01.95]       Expected successfulOperations to be greater than 40 because At least 80% of stress operations should succeed, but found 0 (difference of -40).
[xUnit.net 00:00:01.95]       Stack Trace:
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Database recreated with clean state
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.95]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.95]            at FluentAssertions.Numeric.NumericAssertions`2.BeGreaterThan(T expected, String because, Object[] becauseArgs)
?? Creating tenants...
[xUnit.net 00:00:01.95]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(283,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.RoleAssignmentSystem_UnderStress_ShouldRemainStable()
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNC", "RequestPath": "/api/roles/1/permissions"}
[xUnit.net 00:00:01.95]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:01.96]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithSystemRole_ReturnsSystemPermissions [FAIL]
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:01.96]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:01.96]       Stack Trace:
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Created 38 permissions
?? Creating roles...
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.96]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.96]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(211,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithSystemRole_ReturnsSystemPermissions()
?? ALL LOADED ROLES:
[xUnit.net 00:00:01.96]         --- End of stack trace from previous location ---
?? CreateRoles DEBUG:
   - ID=8, Name='User', TenantId=2
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TND", "RequestPath": "/api/users"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNE", "RequestPath": "/api/roles/2/users"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
[xUnit.net 00:00:01.96]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoleUsers_WithLargeUserBase_ShouldCompleteUnder1Second [FAIL]
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[xUnit.net 00:00:01.96]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.96]       Stack Trace:
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.96]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.96]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Verified user: admin@tenant1.com (ID: 1)
[xUnit.net 00:00:01.96]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(107,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.GetRoleUsers_WithLargeUserBase_ShouldCompleteUnder1Second()
? Verified user: user@tenant1.com (ID: 2)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified user: admin@tenant2.com (ID: 6)
[xUnit.net 00:00:01.96]         --- End of stack trace from previous location ---
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 roles
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
? Created 109 role permissions using only actual business-defined permissions
?? Verification - Created roles:
?? Creating users...
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Adding 7 users to main context
? Created 38 permissions
?? Creating 38 permissions from actual business requirements
?? Creating roles...
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
? Created 109 role permissions using only actual business-defined permissions
? Assigned 38 permissions to SuperAdmin
?? Creating users...
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
?? Roles to be created (8):
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   1. SuperAdmin (TenantId: )
   - tenant2AdminRole found: True
   2. Admin (TenantId: 1)
   - tenant2AdminRole.Id = 7
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
?? Adding 7 users to main context
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   8. User (TenantId: 2)
? Assigned 3 permissions to Tenant2 User
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNF", "RequestPath": "/api/roles/7/permissions"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 8 roles
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Created 7 legacy tenant users
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
?? Verifying test data...
?? Temporarily disabling query filters for verification...
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:31 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.97]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRolePermissions_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:01.97]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:31 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.97]       Stack Trace:
[12:51:31 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Database recreated with clean state
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating tenants...
[xUnit.net 00:00:01.97]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.97]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.97]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(91,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRolePermissions_CrossTenantAttempt_ShouldReturnNotFound()
[xUnit.net 00:00:01.97]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
[12:51:31 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:31 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:31 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:31 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNG", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[xUnit.net 00:00:01.97]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UpdateRolePermissions_ShouldLogPermissionChanges [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:01.97]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.97]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:01.97]       Stack Trace:
[xUnit.net 00:00:01.97]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:01.97]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:01.97]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
? Created 109 role permissions using only actual business-defined permissions
[xUnit.net 00:00:01.97]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
?? Creating users...
[xUnit.net 00:00:01.97]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Adding 7 users to main context
[xUnit.net 00:00:01.97]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(253,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.UpdateRolePermissions_ShouldLogPermissionChanges()
[xUnit.net 00:00:01.97]         --- End of stack trace from previous location ---
[xUnit.net 00:00:01.97]         ----- Inner Stack Trace -----
[xUnit.net 00:00:01.97]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:01.97]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:01.97]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Created 8 user role assignments
?? Creating legacy tenant users...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating roles...
?? Adding 7 users to main context
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? All users created successfully
? Final user count: 7
? All users created successfully
? Verified required user exists: admin@tenant1.com (ID:  1)
? Final user count: 7
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Found 7 users and 8 roles for assignment
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 8 user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNH", "RequestPath": "/api/users/1"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified user: admin@tenant1.com (ID: 1)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Verified user: user@tenant1.com (ID: 2)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.98]     UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_AdminDeletingSelf_ReturnsBadRequest [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:01.99]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
? admin@tenant1.com has 1 role assignments
[xUnit.net 00:00:01.99]       Stack Trace:
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Created 8 user role assignments
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Creating legacy tenant users...
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Database recreated with clean state
[xUnit.net 00:00:01.99]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:01.99]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(443,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_AdminDeletingSelf_ReturnsBadRequest()
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.99]         --- End of stack trace from previous location ---
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 2 tenants
?? Creating permissions...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNI", "RequestPath": "/api/roles/2/permissions"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNJ", "RequestPath": "/api/tenants/role-templates"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 user role assignments
? Verified user: admin@tenant1.com (ID: 1)
?? Creating legacy tenant users...
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Ensuring clean database state...
[xUnit.net 00:00:01.99]     UserService.IntegrationTests.Controllers.TenantsControllerTests.GetRoleTemplates_ShouldReturnAvailableTemplates [FAIL]
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Ensuring clean database state...
[xUnit.net 00:00:01.99]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:01.99]       Stack Trace:
? Database recreated with clean state
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Database recreated with clean state
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Creating tenants...
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Verified user: admin@tenant1.com (ID: 1)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Verified user: user@tenant1.com (ID: 2)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Verified user: admin@tenant2.com (ID: 6)
[xUnit.net 00:00:01.99]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.99]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(312,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.GetRoleTemplates_ShouldReturnAvailableTemplates()
[xUnit.net 00:00:01.99]         --- End of stack trace from previous location ---
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:01.99]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithoutManagePermissionsPermission_ShouldReturnForbidden [FAIL]
[xUnit.net 00:00:01.99]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
? Created 2 tenants
[xUnit.net 00:00:01.99]       Stack Trace:
?? Creating permissions...
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:01.99]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:01.99]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:01.99]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(367,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithoutManagePermissionsPermission_ShouldReturnForbidden()
? Created 2 tenants
?? Creating permissions...
[xUnit.net 00:00:01.99]         --- End of stack trace from previous location ---
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNK", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNL", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:02.00]     UserService.IntegrationTests.Performance.UserCountPerformanceTests.UserCountQueries_ShouldUseEfficientSQLQueries [FAIL]
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[xUnit.net 00:00:02.00]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.00]       Stack Trace:
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
? Created 8 roles
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
[xUnit.net 00:00:02.00]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? Verification - Created roles:
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
? Assigned 3 permissions to Tenant2 User
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
[xUnit.net 00:00:02.00]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Performance\UserCountPerformanceTests.cs(171,0): at UserService.IntegrationTests.Performance.UserCountPerformanceTests.UserCountQueries_ShouldUseEfficientSQLQueries()
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:02.00]         --- End of stack trace from previous location ---
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? Ensuring clean database state...
? Assigned 38 permissions to SuperAdmin
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified user: admin@tenant1.com (ID: 1)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[xUnit.net 00:00:02.00]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithZeroPageNumber_ShouldReturnBadRequest [FAIL]
[xUnit.net 00:00:02.00]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
? Created 2 tenants
[xUnit.net 00:00:02.00]       Stack Trace:
?? Creating permissions...
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - billing.process_payments (Billing)
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - billing.view (Billing)
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - permissions.delete (Permissions)
[xUnit.net 00:00:02.00]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:02.00]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - permissions.edit (Permissions)
[xUnit.net 00:00:02.00]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(387,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithZeroPageNumber_ShouldReturnBadRequest()
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:02.00]         --- End of stack trace from previous location ---
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNM", "RequestPath": "/api/roles"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNN", "RequestPath": "/api/users/6"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNO", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.01]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateUser_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
[xUnit.net 00:00:02.01]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.01]       Stack Trace:
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - Permissions: 28
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Ensuring clean database state...
[xUnit.net 00:00:02.01]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.01]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(304,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateUser_CrossTenantAttempt_ShouldReturnNotFound()
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNP", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.01]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNQ", "RequestPath": "/api/roles"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNR", "RequestPath": "/api/roles/4/permissions"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.01]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithMultiplePermissions_ReturnsAllPermissions [FAIL]
[xUnit.net 00:00:02.01]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNS", "RequestPath": "/api/roles"}
? Created 38 permissions
[xUnit.net 00:00:02.01]       Stack Trace:
?? Creating roles...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Created 109 role permissions using only actual business-defined permissions
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Creating users...
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.01]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? CreateRoles DEBUG:
[xUnit.net 00:00:02.01]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Adding 7 users to main context
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:02.01]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(576,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRolePermissions_WithMultiplePermissions_ReturnsAllPermissions()
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
[xUnit.net 00:00:02.01]         --- End of stack trace from previous location ---
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNT", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNV", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TNU", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO0", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.02]     UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.CreateRole_ShouldGenerateAuditLogEntry [FAIL]
[xUnit.net 00:00:02.02]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.02]       Stack Trace:
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.02]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.02]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.02]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Auditing\AuditLoggingVerificationTests.cs(43,0): at UserService.IntegrationTests.Auditing.AuditLoggingVerificationTests.CreateRole_ShouldGenerateAuditLogEntry()
? Created 109 role permissions using only actual business-defined permissions
[xUnit.net 00:00:02.02]         --- End of stack trace from previous location ---
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO1", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO2", "RequestPath": "/api/roles"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO3", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO4", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO5", "RequestPath": "/api/users/profile"}
? All users created successfully
? Final user count: 7
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO6", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO7", "RequestPath": "/api/roles"}
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.03]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserProfile_WithRBACRoles_ReturnsCorrectRoles [FAIL]
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:02.03]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.03]       Stack Trace:
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.03]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Ensuring clean database state...
[xUnit.net 00:00:02.03]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.03]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(116,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserProfile_WithRBACRoles_ReturnsCorrectRoles()
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:02.03]         --- End of stack trace from previous location ---
?? Adding 8 user role assignments...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO8", "RequestPath": "/api/roles"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 2 tenants
?? Creating permissions...
? Verified required user exists: user@tenant1.com (ID:  2)
? All users created successfully
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
? Final user count: 7
   - permissions.create (Permissions)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
?? Creating user role assignments...
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TO9", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOA", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOB", "RequestPath": "/api/tenants"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOC", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOD", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOE", "RequestPath": "/api/tenants"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:02.04]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithDuplicatePermissions_ShouldHandleGracefully [FAIL]
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[xUnit.net 00:00:02.04]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.04]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.04]       Stack Trace:
[xUnit.net 00:00:02.04]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.04]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:02.04]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.04]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
?? ALL LOADED ROLES:
[xUnit.net 00:00:02.04]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:02.04]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(87,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithDuplicatePermissions_ShouldHandleGracefully()
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:02.04]         --- End of stack trace from previous location ---
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:02.04]         ----- Inner Stack Trace -----
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.04]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.04]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.04]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
?? Ensuring clean database state...
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOF", "RequestPath": "/api/roles"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
? Created 8 user role assignments
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
?? Creating legacy tenant users...
[xUnit.net 00:00:02.04]     UserService.IntegrationTests.Controllers.TenantsControllerTests.CreateTenant_WithDuplicateDomain_ShouldReturnError [FAIL]
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
? Created 8 user role assignments
[xUnit.net 00:00:02.04]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
   - roles.assign_users (Roles)
?? Creating legacy tenant users...
[xUnit.net 00:00:02.04]       Stack Trace:
   - roles.create (Roles)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - roles.delete (Roles)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - roles.edit (Roles)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.04]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - roles.manage_permissions (Roles)
[xUnit.net 00:00:02.04]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - roles.view (Roles)
[xUnit.net 00:00:02.04]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(111,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.CreateTenant_WithDuplicateDomain_ShouldReturnError()
   - system.manage (System)
[xUnit.net 00:00:02.04]         --- End of stack trace from previous location ---
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOG", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOH", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOI", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 8 roles
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
?? Verification - Created roles:
   - ID=4, Name='Manager', TenantId=1
   - ID=8, Name='User', TenantId=2
   - ID=3, Name='User', TenantId=1
   - ID=7, Name='Admin', TenantId=2
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOJ", "RequestPath": "/api/roles"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating users...
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 7 users to main context
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOK", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOL", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOM", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TON", "RequestPath": "/api/roles/7/users"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOO", "RequestPath": "/api/users"}
? All users created successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOR", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOQ", "RequestPath": "/api/roles"}
? Final user count: 7
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Adding 7 users to main context
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.05]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.GetUserRoles_WithManyRoles_ShouldMaintainPerformance [FAIL]
[xUnit.net 00:00:02.05]       System.InvalidOperationException : Failed to create test user. Status: Unauthorized, Content: 
?? Ensuring clean database state...
[xUnit.net 00:00:02.05]       Stack Trace:
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:02.05]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(360,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.CreateTestUserForLoadTesting()
?? Adding 8 user role assignments...
[xUnit.net 00:00:02.05]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(170,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.GetUserRoles_WithManyRoles_ShouldMaintainPerformance()
[xUnit.net 00:00:02.05]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.05]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithAdminToken_ReturnsRoleList [FAIL]
? Database recreated with clean state
[xUnit.net 00:00:02.05]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Ensuring clean database state...
[xUnit.net 00:00:02.05]       Stack Trace:
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Created 2 tenants
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating permissions...
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.05]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.05]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(33,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithAdminToken_ReturnsRoleList()
[xUnit.net 00:00:02.05]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.05]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRoleUsers_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
[xUnit.net 00:00:02.05]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
? Database recreated with clean state
[xUnit.net 00:00:02.05]       Stack Trace:
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - roles.assign_users (Roles)
[xUnit.net 00:00:02.05]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - roles.create (Roles)
[xUnit.net 00:00:02.05]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - roles.delete (Roles)
[xUnit.net 00:00:02.05]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(127,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRoleUsers_CrossTenantAttempt_ShouldReturnNotFound()
   - roles.edit (Roles)
[xUnit.net 00:00:02.05]         --- End of stack trace from previous location ---
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
? Created 2 tenants
   - users.edit (Users)
   - users.manage_roles (Users)
?? Creating permissions...
   - users.view (Users)
   - users.view_all (Users)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
? Created 2 tenants
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOP", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? All users created successfully
? Created 38 permissions
?? Creating roles...
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
? Verified required user exists: user@tenant1.com (ID:  2)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:02.06]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_ConcurrentCreationWithSameName_ShouldHandleRaceCondition [FAIL]
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.06]       Expected (successCount + conflictCount) to be 3 because All requests should complete, but found 0 (difference of -3).
[xUnit.net 00:00:02.06]       Stack Trace:
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Ensuring clean database state...
[xUnit.net 00:00:02.06]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.06]            at FluentAssertions.Numeric.NumericAssertions`2.Be(T expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.06]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(553,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_ConcurrentCreationWithSameName_ShouldHandleRaceCondition()
[xUnit.net 00:00:02.06]         --- End of stack trace from previous location ---
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
? Created 8 roles
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
? Assigned 6 permissions to Tenant1 Manager
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - ID=3, Name='User', TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
?? Adding 7 users to main context
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Final user count: 7
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOS", "RequestPath": "/api/users"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? All users created successfully
?? Adding 7 users to main context
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[xUnit.net 00:00:02.07]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_Tenant1Admin_OnlySeesOwnTenantUsers [FAIL]
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:02.07]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Ensuring clean database state...
[xUnit.net 00:00:02.07]       Stack Trace:
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? All users created successfully
[xUnit.net 00:00:02.07]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Adding 8 user role assignments...
[xUnit.net 00:00:02.07]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Created 109 role permissions using only actual business-defined permissions
[xUnit.net 00:00:02.07]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(308,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_Tenant1Admin_OnlySeesOwnTenantUsers()
? Database recreated with clean state
[xUnit.net 00:00:02.07]         --- End of stack trace from previous location ---
?? Creating users...
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Final user count: 7
?? Adding 7 users to main context
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Created 2 tenants
?? Creating permissions...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for manager@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Manager
   - Permissions: 6
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOT", "RequestPath": "/api/roles/2/permissions"}
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? All users created successfully
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
? Created 8 user role assignments
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
?? Creating legacy tenant users...
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Assigned 3 permissions to Tenant1 User
? Final user count: 7
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.08]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.GetRolePermissions_WithViewPermission_ShouldSucceed [FAIL]
? Created 8 user role assignments
?? Creating legacy tenant users...
[xUnit.net 00:00:02.08]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.08]       Stack Trace:
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.08]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.08]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.08]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(384,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.GetRolePermissions_WithViewPermission_ShouldSucceed()
[xUnit.net 00:00:02.08]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOU", "RequestPath": "/api/tenants"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.08]     UserService.IntegrationTests.Controllers.TenantsControllerTests.InitializeTenant_ShouldCreateDefaultRoles [FAIL]
[xUnit.net 00:00:02.08]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.08]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.08]       Stack Trace:
?? Ensuring clean database state...
[xUnit.net 00:00:02.08]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.08]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.08]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.08]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
? Database recreated with clean state
[xUnit.net 00:00:02.08]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.08]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(269,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.InitializeTenant_ShouldCreateDefaultRoles()
[xUnit.net 00:00:02.08]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.08]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.08]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.08]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.08]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 38 permissions
?? Creating roles...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified user: admin@tenant1.com (ID: 1)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TOV", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Permissions: 28
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP1", "RequestPath": "/api/roles/2/users"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Final user count: 7
?? Adding 7 users to main context
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP0", "RequestPath": "/api/roles"}
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP2", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.09]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithAdminRole_ReturnsAssignedUsers [FAIL]
[xUnit.net 00:00:02.09]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Ensuring clean database state...
[xUnit.net 00:00:02.09]       Stack Trace:
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Database recreated with clean state
[xUnit.net 00:00:02.09]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.09]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(313,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithAdminRole_ReturnsAssignedUsers()
?? Creating tenants...
[xUnit.net 00:00:02.09]         --- End of stack trace from previous location ---
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP3", "RequestPath": "/api/roles"}
? Created 2 tenants
?? Creating permissions...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP4", "RequestPath": "/api/roles/7"}
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.09]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithExtremelyLargePageNumber_ShouldReturnEmptyResult [FAIL]
[xUnit.net 00:00:02.09]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Ensuring clean database state...
?? Found 7 users and 8 roles for assignment
[xUnit.net 00:00:02.09]       Stack Trace:
?? Adding 8 user role assignments...
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.09]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.09]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(404,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithExtremelyLargePageNumber_ShouldReturnEmptyResult()
[xUnit.net 00:00:02.09]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.09]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRole_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
[xUnit.net 00:00:02.09]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.09]       Stack Trace:
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.09]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.09]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.09]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(33,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRole_CrossTenantAttempt_ShouldReturnNotFound()
[xUnit.net 00:00:02.09]         --- End of stack trace from previous location ---
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 2 tenants
?? Creating permissions...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
?? Creating 38 permissions from actual business requirements
   - roles.edit (Roles)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
? Created 38 permissions
   - tenants.edit (Tenants)
?? Creating roles...
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
   - billing.view (Billing)
?? CreateRoles DEBUG:
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - tenant1.Id = 1
   - system.view_metrics (System)
   - tenant2.Id = 2
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP5", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 38 permissions
?? Creating roles...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? CreateRoles DEBUG:
   - ID=8, Name='User', TenantId=2
   - tenant1.Id = 1
   - tenant2.Id = 2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
?? Roles to be created (8):
   - ID=3, Name='User', TenantId=1
   1. SuperAdmin (TenantId: )
   - ID=2, Name='Admin', TenantId=1
   2. Admin (TenantId: 1)
   - ID=1, Name='SuperAdmin', TenantId=
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP6", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
? Verified user: admin@tenant1.com (ID: 1)
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Verified user: user@tenant1.com (ID: 2)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Verified user: admin@tenant2.com (ID: 6)
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP7", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP8", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TP9", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPA", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPB", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPC", "RequestPath": "/api/users/999"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPD", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.11]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_NonExistentUser_ReturnsNotFound [FAIL]
[xUnit.net 00:00:02.11]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.11]       Stack Trace:
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.11]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.11]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Ensuring clean database state...
[xUnit.net 00:00:02.11]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(290,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_NonExistentUser_ReturnsNotFound()
[xUnit.net 00:00:02.11]         --- End of stack trace from previous location ---
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPE", "RequestPath": "/api/roles"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Creating 38 permissions from actual business requirements
? Verified required user exists: user@tenant1.com (ID:  2)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
? Verified required user exists: admin@tenant2.com (ID:  6)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPF", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPG", "RequestPath": "/api/roles"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPH", "RequestPath": "/api/roles"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
? All users created successfully
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
? Final user count: 7
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPI", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPJ", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.11]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRole_ShouldPreserveExistingPermissions_WhenNotSpecified [FAIL]
[xUnit.net 00:00:02.11]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.11]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.11]       Stack Trace:
[xUnit.net 00:00:02.11]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.11]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.11]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.11]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:02.11]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:02.11]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(283,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRole_ShouldPreserveExistingPermissions_WhenNotSpecified()
[xUnit.net 00:00:02.11]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.11]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.11]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.11]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.11]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
?? Ensuring clean database state...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPK", "RequestPath": "/api/roles"}
? Database recreated with clean state
? Created 8 roles
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 2 tenants
?? Creating permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
? Assigned 28 permissions to Tenant1 Admin
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
? Assigned 3 permissions to Tenant1 User
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
? Assigned 6 permissions to Tenant1 Manager
   - users.view (Users)
   - users.view_all (Users)
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPL", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPM", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 38 permissions
?? Creating roles...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPN", "RequestPath": "/api/tenants"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPO", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? All users created successfully
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Final user count: 7
? Verified user: admin@tenant1.com (ID: 1)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:02.12]     UserService.IntegrationTests.Controllers.TenantsControllerTests.CreateTenant_WithValidData_ShouldCreateTenantAndAdminUser [FAIL]
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Verified user: user@tenant1.com (ID: 2)
[xUnit.net 00:00:02.12]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.12]       Stack Trace:
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.12]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.12]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.12]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\TenantsControllerTests.cs(43,0): at UserService.IntegrationTests.Controllers.TenantsControllerTests.CreateTenant_WithValidData_ShouldCreateTenantAndAdminUser()
[xUnit.net 00:00:02.12]         --- End of stack trace from previous location ---
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: admin@tenant1.com (ID:  1)
? admin@tenant1.com has 1 role assignments
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
? Verified required user exists: user@tenant1.com (ID:  2)
   - ID=8, Name='User', TenantId=2
? TestDataSeeder: Test data seeding completed successfully
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
? Verified required user exists: admin@tenant2.com (ID:  6)
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPP", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPQ", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPR", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPS", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPT", "RequestPath": "/api/roles/4/users/3"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPU", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.13]     UserService.IntegrationTests.Controllers.RolesControllerTests.RemoveRoleFromUser_WithValidData_ReturnsSuccess [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:02.13]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.13]       Stack Trace:
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Database recreated with clean state
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.13]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Generated tenant-aware JWT for admin@tenant1.com:
[xUnit.net 00:00:02.13]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(168,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.RemoveRoleFromUser_WithValidData_ReturnsSuccess()
?? Creating tenants...
   - Tenant: Test Tenant 1 (ID: 1)
[xUnit.net 00:00:02.13]         --- End of stack trace from previous location ---
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TPV", "RequestPath": "/api/users"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[xUnit.net 00:00:02.13]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.RemoveRoles_BulkRemoval_ShouldCompleteEfficiently [FAIL]
[xUnit.net 00:00:02.13]       System.InvalidOperationException : Failed to create test user. Status: Unauthorized, Content: 
[xUnit.net 00:00:02.13]       Stack Trace:
[xUnit.net 00:00:02.13]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(360,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.CreateTestUserForLoadTesting()
[xUnit.net 00:00:02.13]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(123,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.RemoveRoles_BulkRemoval_ShouldCompleteEfficiently()
[xUnit.net 00:00:02.13]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
? Created 38 permissions
?? Creating roles...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ0", "RequestPath": "/api/roles/7"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:02.13]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateRole_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[xUnit.net 00:00:02.13]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.13]       Stack Trace:
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? ALL LOADED ROLES:
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.13]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
[xUnit.net 00:00:02.13]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
[xUnit.net 00:00:02.13]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(57,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.UpdateRole_CrossTenantAttempt_ShouldReturnNotFound()
?? DEBUG: Found 28 permissions for Tenant2 Admin
?? Ensuring clean database state...
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.13]         --- End of stack trace from previous location ---
? Created 38 permissions
?? Creating roles...
? All users created successfully
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Final user count: 7
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 2 tenants
?? Creating permissions...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 38 permissions
?? Creating roles...
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ1", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.14]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithZeroPageSize_ShouldReturnBadRequest [FAIL]
? Created 7 legacy tenant users
[xUnit.net 00:00:02.14]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Ensuring clean database state...
? All users created successfully
[xUnit.net 00:00:02.14]       Stack Trace:
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Final user count: 7
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified user: admin@tenant1.com (ID: 1)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.14]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating tenants...
[xUnit.net 00:00:02.14]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified user: user@tenant1.com (ID: 2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:02.14]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(336,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithZeroPageSize_ShouldReturnBadRequest()
? Verified user: admin@tenant2.com (ID: 6)
? Created 2 tenants
?? Creating permissions...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
[xUnit.net 00:00:02.15]         --- End of stack trace from previous location ---
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Adding 7 users to main context
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ2", "RequestPath": "/api/users/3"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ3", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.15]     UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_UserTryingToDelete_ReturnsForbidden [FAIL]
[xUnit.net 00:00:02.15]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.15]       Stack Trace:
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.15]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.15]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(461,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_UserTryingToDelete_ReturnsForbidden()
?? Ensuring clean database state...
[xUnit.net 00:00:02.15]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.15]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.CreateRole_WithComprehensivePermissions_ShouldSucceed [FAIL]
[xUnit.net 00:00:02.15]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.15]       Stack Trace:
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Created 2 tenants
?? Creating permissions...
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.15]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.15]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
[xUnit.net 00:00:02.15]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(229,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.CreateRole_WithComprehensivePermissions_ShouldSucceed()
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
[xUnit.net 00:00:02.15]         --- End of stack trace from previous location ---
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant2.com (ID: 6)
? Created 38 permissions
? Created 38 permissions
?? Creating roles...
?? Creating roles...
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   - tenant1.Id = 1
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Adding 7 users to main context
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Generated tenant-aware JWT for admin@tenant1.com:
   - ID=8, Name='User', TenantId=2
   - Tenant: Test Tenant 1 (ID: 1)
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - Roles: Admin
   - Permissions: 28
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ4", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? All users created successfully
? Final user count: 7
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating user role assignments...
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.16]     UserService.IntegrationTests.Controllers.RolesControllerTests.CreateRole_WithValidData_ReturnsCreatedRole [FAIL]
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.16]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.16]       Stack Trace:
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.16]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.16]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.16]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(60,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.CreateRole_WithValidData_ReturnsCreatedRole()
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.16]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ5", "RequestPath": "/api/users"}
[12:51:32 WRN] Failed to create test user 1: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Generated tenant-aware JWT for admin@tenant1.com:
?? Adding 7 users to main context
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ6", "RequestPath": "/api/users/7"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ7", "RequestPath": "/api/users"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 WRN] Failed to create test user 2: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:02.17]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.DeleteUser_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
[xUnit.net 00:00:02.17]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
? All users created successfully
[xUnit.net 00:00:02.17]       Stack Trace:
? Final user count: 7
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Verified required user exists: admin@tenant1.com (ID:  1)
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.17]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.17]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? Ensuring clean database state...
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
[xUnit.net 00:00:02.17]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(321,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.DeleteUser_CrossTenantAttempt_ShouldReturnNotFound()
?? Creating user role assignments...
[xUnit.net 00:00:02.17]         --- End of stack trace from previous location ---
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Created 38 permissions
?? Creating roles...
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
   5. Viewer (TenantId: 1)
?? Creating user role assignments...
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ8", "RequestPath": "/api/users"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 WRN] Failed to create test user 3: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQ9", "RequestPath": "/api/users"}
[12:51:32 WRN] Failed to create test user 4: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQA", "RequestPath": "/api/users"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQB", "RequestPath": "/api/roles/99999"}
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 WRN] Failed to create test user 5: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Final user count: 7
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant1.com (ID:  1)
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQC", "RequestPath": "/api/roles"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQD", "RequestPath": "/api/users"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 WRN] Failed to create test user 6: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQE", "RequestPath": "/api/roles/1/permissions"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQF", "RequestPath": "/api/users"}
[xUnit.net 00:00:02.19]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.ErrorResponses_ShouldHaveConsistentFormat [FAIL]
?? Ensuring clean database state...
[12:51:32 WRN] Failed to create test user 7: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQG", "RequestPath": "/api/roles"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.19]       Expected content "" to contain "success".
?? Generated tenant-aware JWT for admin@tenant2.com:
[xUnit.net 00:00:02.19]       Stack Trace:
   - Tenant: Test Tenant 2 (ID: 2)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - Roles: Admin
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - Permissions: 28
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 2 tenants
?? Creating permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - reports.create (Reports)
   - reports.export (Reports)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
[xUnit.net 00:00:02.19]            at FluentAssertions.Primitives.StringAssertions`1.Contain(String expected, String because, Object[] becauseArgs)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
[xUnit.net 00:00:02.19]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(607,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.ErrorResponses_ShouldHaveConsistentFormat()
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
[xUnit.net 00:00:02.19]         --- End of stack trace from previous location ---
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:02.19]     UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithEmptyPermissionList_ShouldSucceed [FAIL]
?? All users created and verified successfully!
[xUnit.net 00:00:02.19]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
?? Creating user role assignments...
[xUnit.net 00:00:02.19]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.19]       Stack Trace:
[xUnit.net 00:00:02.19]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[xUnit.net 00:00:02.19]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.19]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.19]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:02.19]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQI", "RequestPath": "/api/users"}
[xUnit.net 00:00:02.19]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolePermissionManagementTests.cs(56,0): at UserService.IntegrationTests.Controllers.RolePermissionManagementTests.UpdateRolePermissions_WithEmptyPermissionList_ShouldSucceed()
[xUnit.net 00:00:02.19]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.19]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.19]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[12:51:32 WRN] Failed to create test user 8: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.19]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.19]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Created 38 permissions
?? Creating roles...
?? Generated tenant-aware JWT for admin@tenant1.com:
?? CreateRoles DEBUG:
   - Tenant: Test Tenant 1 (ID: 1)
   - tenant1.Id = 1
   - Roles: Admin
   - Permissions: 28
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQH", "RequestPath": "/api/users"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQJ", "RequestPath": "/api/users"}
[12:51:32 WRN] Failed to create test user 9: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Generated tenant-aware JWT for admin@tenant1.com:
   - ID=8, Name='User', TenantId=2
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.19]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_Tenant2Admin_OnlySeesOwnTenantUsers [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:02.19]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.19]       Stack Trace:
? Database recreated with clean state
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 8 user role assignments
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating legacy tenant users...
[xUnit.net 00:00:02.19]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQK", "RequestPath": "/api/users"}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.19]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
[xUnit.net 00:00:02.19]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(337,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_Tenant2Admin_OnlySeesOwnTenantUsers()
   - roles.view (Roles)
[xUnit.net 00:00:02.19]         --- End of stack trace from previous location ---
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
[12:51:32 WRN] Failed to create test user 10: Failed to create test user. Status: Unauthorized, Content:  {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQL", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
?? Generated tenant-aware JWT for admin@tenant1.com:
   - ID=3, Name='User', TenantId=1
   - Tenant: Test Tenant 1 (ID: 1)
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - Roles: Admin
? Successfully created all 8 roles including 2 Tenant 2 roles
   - Permissions: 28
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQM", "RequestPath": "/api/roles"}
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQO", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQN", "RequestPath": "/api/roles/2/permissions"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQP", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.20]     UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRolePermissions_WithValidData_ReturnsSuccess [FAIL]
?? Ensuring clean database state...
? Database recreated with clean state
[xUnit.net 00:00:02.20]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.20]       Stack Trace:
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.20]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.20]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(235,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRolePermissions_WithValidData_ReturnsSuccess()
[xUnit.net 00:00:02.20]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQQ", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQR", "RequestPath": "/api/roles"}
? Final user count: 7
? Created 38 permissions
?? Creating roles...
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
   4. Manager (TenantId: 1)
?? Creating user role assignments...
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQS", "RequestPath": "/api/roles/8"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQT", "RequestPath": "/api/roles"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:02.20]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.DeleteRole_CrossTenantAttempt_ShouldReturnNotFound [FAIL]
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:02.20]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:02.20]       Stack Trace:
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - tenant2.Id = 2
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - All roles count: 8
[xUnit.net 00:00:02.20]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
[xUnit.net 00:00:02.20]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQU", "RequestPath": "/api/roles"}
?? Ensuring clean database state...
[xUnit.net 00:00:02.20]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(74,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.DeleteRole_CrossTenantAttempt_ShouldReturnNotFound()
[xUnit.net 00:00:02.20]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TQV", "RequestPath": "/api/roles"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR0", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Created 38 permissions
?? Creating roles...
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR1", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR2", "RequestPath": "/api/roles"}
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR3", "RequestPath": "/api/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR4", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
? Verified user: admin@tenant2.com (ID: 6)
?? Adding 7 users to main context
? Created 8 user role assignments
? admin@tenant1.com has 1 role assignments
?? Creating legacy tenant users...
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR5", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR6", "RequestPath": "/api/roles"}
? All users created successfully
? Final user count: 7
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR7", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR9", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TR8", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRA", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.22]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithNegativePageSize_ShouldReturnBadRequest [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:02.22]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.22]       Stack Trace:
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Database recreated with clean state
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating tenants...
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.22]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.22]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(353,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRoles_WithNegativePageSize_ShouldReturnBadRequest()
[xUnit.net 00:00:02.22]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRB", "RequestPath": "/api/roles"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRC", "RequestPath": "/api/users/2"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRD", "RequestPath": "/api/roles"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.22]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_AdminAccessingAnyUser_ReturnsUser [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:02.22]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.22]       Stack Trace:
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 8 roles
?? Verification - Created roles:
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRE", "RequestPath": "/api/roles"}
? Created 2 tenants
?? Creating permissions...
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.22]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.22]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.22]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(240,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_AdminAccessingAnyUser_ReturnsUser()
   - billing.manage (Billing)
   - billing.process_payments (Billing)
[xUnit.net 00:00:02.22]         --- End of stack trace from previous location ---
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRF", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRG", "RequestPath": "/api/roles"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRH", "RequestPath": "/api/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.23]     UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.GetRoleUsers_WithManyUsersPerRole_ShouldScaleWell [FAIL]
[xUnit.net 00:00:02.23]       System.InvalidOperationException : Sequence contains no elements
[xUnit.net 00:00:02.23]       Stack Trace:
[xUnit.net 00:00:02.23]            at System.Linq.ThrowHelper.ThrowNoElementsException()
[xUnit.net 00:00:02.23]            at System.Linq.Enumerable.First[TSource](IEnumerable`1 source)
[xUnit.net 00:00:02.23]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\LoadTesting\RoleAssignmentLoadTests.cs(212,0): at UserService.IntegrationTests.LoadTesting.RoleAssignmentLoadTests.GetRoleUsers_WithManyUsersPerRole_ShouldScaleWell()
[xUnit.net 00:00:02.23]         --- End of stack trace from previous location ---
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRI", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.23]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithViewerRole_ReturnsAssignedUsers [FAIL]
[xUnit.net 00:00:02.23]       Expected rolesResponse.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.23]       Stack Trace:
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.23]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.23]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(329,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithViewerRole_ReturnsAssignedUsers()
[xUnit.net 00:00:02.23]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Creating roles...
? All users created successfully
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
? Final user count: 7
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRJ", "RequestPath": "/api/roles"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
[xUnit.net 00:00:02.23]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRoles_ShouldOnlyReturnCurrentTenantAndSystemRoles [FAIL]
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:02.23]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.23]       Stack Trace:
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - ID=2, Name='Admin', TenantId=1
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
? Assigned 38 permissions to SuperAdmin
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Assigned 28 permissions to Tenant1 Admin
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Assigned 3 permissions to Tenant1 User
[xUnit.net 00:00:02.23]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.23]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.23]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(342,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetRoles_ShouldOnlyReturnCurrentTenantAndSystemRoles()
[xUnit.net 00:00:02.23]         --- End of stack trace from previous location ---
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Created 109 role permissions using only actual business-defined permissions
? Verified user: user@tenant1.com (ID: 2)
?? Creating users...
? Verified user: admin@tenant2.com (ID: 6)
?? Adding 7 users to main context
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRK", "RequestPath": "/api/roles/2"}
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified user: admin@tenant1.com (ID: 1)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
?? Found 7 users and 8 roles for assignment
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.25]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.DeleteRole_WithUsersAssigned_ShouldReturnConflict [FAIL]
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.25]       Expected response.StatusCode to be HttpStatusCode.InternalServerError {value: 500}, but found HttpStatusCode.Unauthorized {value: 401}.
?? Creating tenants...
? Created 2 tenants
[xUnit.net 00:00:02.25]       Stack Trace:
?? Creating permissions...
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - billing.manage (Billing)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - billing.process_payments (Billing)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.25]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:02.25]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(315,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.DeleteRole_WithUsersAssigned_ShouldReturnConflict()
   - permissions.create (Permissions)
[xUnit.net 00:00:02.25]         --- End of stack trace from previous location ---
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
? Final user count: 7
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRL", "RequestPath": "/api/users/1/roles"}
[xUnit.net 00:00:02.25]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserRoles_WithValidUser_ReturnsRoles [FAIL]
[xUnit.net 00:00:02.25]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.25]       Stack Trace:
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.25]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.25]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.25]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(576,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserRoles_WithValidUser_ReturnsRoles()
[xUnit.net 00:00:02.25]         --- End of stack trace from previous location ---
? Database recreated with clean state
? Created 7 legacy tenant users
?? TestDataSeeder: Starting test data seeding
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Creating tenants...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 2 tenants
?? Creating permissions...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRM", "RequestPath": "/api/roles"}
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 WRN] Could not get Tenant 2 roles. Response: Unauthorized {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRN", "RequestPath": "/api/roles/7/users"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:02.26]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_CrossTenantAttempt_ReturnsNotFound [FAIL]
[xUnit.net 00:00:02.26]       Expected response.StatusCode to be one of {HttpStatusCode.NotFound {value: 404}, HttpStatusCode.InternalServerError {value: 500}}, but found HttpStatusCode.Unauthorized {value: 401}.
? All users created successfully
[xUnit.net 00:00:02.26]       Stack Trace:
?? Ensuring clean database state...
? Final user count: 7
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
? Verified required user exists: admin@tenant1.com (ID:  1)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Database recreated with clean state
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Creating tenants...
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Verified required user exists: user@tenant1.com (ID:  2)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Verified required user exists: admin@tenant2.com (ID:  6)
[xUnit.net 00:00:02.26]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
? Verified required user exists: user@tenant2.com (ID:  7)
[xUnit.net 00:00:02.26]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
?? All users created and verified successfully!
?? Creating user role assignments...
[xUnit.net 00:00:02.26]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(416,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_CrossTenantAttempt_ReturnsNotFound()
[xUnit.net 00:00:02.26]         --- End of stack trace from previous location ---
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRO", "RequestPath": "/api/roles/users/6"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 38 permissions
?? Creating roles...
[xUnit.net 00:00:02.26]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUserRoles_CrossTenantUser_ShouldReturnForbiddenOrNotFound [FAIL]
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
[xUnit.net 00:00:02.26]       Expected response.StatusCode to be one of {HttpStatusCode.Forbidden {value: 403}, HttpStatusCode.NotFound {value: 404}, HttpStatusCode.InternalServerError {value: 500}}, but found HttpStatusCode.Unauthorized {value: 401}.
   2. Admin (TenantId: 1)
[xUnit.net 00:00:02.26]       Stack Trace:
   3. User (TenantId: 1)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   4. Manager (TenantId: 1)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.26]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
? Created 2 tenants
?? Creating permissions...
[xUnit.net 00:00:02.26]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
[xUnit.net 00:00:02.26]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
[xUnit.net 00:00:02.26]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(241,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUserRoles_CrossTenantUser_ShouldReturnForbiddenOrNotFound()
   - roles.assign_users (Roles)
[xUnit.net 00:00:02.26]         --- End of stack trace from previous location ---
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRP", "RequestPath": "/api/roles"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? All users created successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: admin@tenant2.com (ID:  6)
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.28]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithExtraProperties_ShouldIgnoreOrFail [FAIL]
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.28]       Expected response.StatusCode to be one of {HttpStatusCode.Created {value: 201}, HttpStatusCode.BadRequest {value: 400}}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.28]       Stack Trace:
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
? Created 2 tenants
?? Creating permissions...
? All users created successfully
? Final user count: 7
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Creating 38 permissions from actual business requirements
[xUnit.net 00:00:02.28]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
   - billing.manage (Billing)
[xUnit.net 00:00:02.28]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
   - billing.process_payments (Billing)
[xUnit.net 00:00:02.28]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(208,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithExtraProperties_ShouldIgnoreOrFail()
[xUnit.net 00:00:02.28]         --- End of stack trace from previous location ---
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
? Verified required user exists: admin@tenant1.com (ID:  1)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRQ", "RequestPath": "/api/users/1/permissions"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.28]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserPermissions_WithValidUser_ReturnsPermissions [FAIL]
[xUnit.net 00:00:02.28]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.28]       Stack Trace:
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.28]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.28]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.28]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(635,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUserPermissions_WithValidUser_ReturnsPermissions()
[xUnit.net 00:00:02.28]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 2 tenants
?? Creating permissions...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
? Verified user: admin@tenant2.com (ID: 6)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRR", "RequestPath": "/api/roles"}
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.29]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithUserAssignments_ReturnsCorrectUserCounts [FAIL]
[xUnit.net 00:00:02.29]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.29]       Stack Trace:
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.29]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.29]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(279,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoles_WithUserAssignments_ReturnsCorrectUserCounts()
[xUnit.net 00:00:02.29]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRS", "RequestPath": "/api/users"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
[xUnit.net 00:00:02.29]     UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUsers_ShouldOnlyReturnCurrentTenantUsers [FAIL]
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
[xUnit.net 00:00:02.29]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
   - All roles count: 8
[xUnit.net 00:00:02.29]       Stack Trace:
   - Roles with TenantId = 2: 2
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.29]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.29]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.29]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Security\CrossTenantSecurityTests.cs(278,0): at UserService.IntegrationTests.Security.CrossTenantSecurityTests.GetUsers_ShouldOnlyReturnCurrentTenantUsers()
[xUnit.net 00:00:02.29]         --- End of stack trace from previous location ---
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRT", "RequestPath": "/api/roles"}
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.30]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithSpecialCharacters_ShouldHandleGracefully [FAIL]
[xUnit.net 00:00:02.30]       Expected response.StatusCode to be one of {HttpStatusCode.Created {value: 201}, HttpStatusCode.BadRequest {value: 400}}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.30]       Stack Trace:
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.30]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.30]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.30]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
[xUnit.net 00:00:02.30]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(106,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithSpecialCharacters_ShouldHandleGracefully()
[xUnit.net 00:00:02.30]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Generated tenant-aware JWT for manager@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Manager
   - Permissions: 6
? Created 38 permissions
?? Creating roles...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRU", "RequestPath": "/api/users"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.31]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithManagerRole_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.31]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.31]       Stack Trace:
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
? Created 8 roles
?? Ensuring clean database state...
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Verification - Created roles:
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=4, Name='Manager', TenantId=1
[xUnit.net 00:00:02.31]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.31]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.31]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(179,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithManagerRole_ReturnsSuccess()
[xUnit.net 00:00:02.31]         --- End of stack trace from previous location ---
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TRV", "RequestPath": "/api/roles"}
[xUnit.net 00:00:02.31]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithEmptyRole_ReturnsEmptyList [FAIL]
? Created 109 role permissions using only actual business-defined permissions
[xUnit.net 00:00:02.31]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
?? Ensuring clean database state...
[xUnit.net 00:00:02.31]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
?? Creating users...
[xUnit.net 00:00:02.31]       Stack Trace:
?? Adding 7 users to main context
[xUnit.net 00:00:02.32]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.32]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.32]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.32]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:02.32]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:02.32]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(368,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithEmptyRole_ReturnsEmptyList()
[xUnit.net 00:00:02.32]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.32]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.32]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.32]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.32]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
? Verified required user exists: admin@tenant1.com (ID:  1)
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? Found 7 users and 8 roles for assignment
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
?? Adding 8 user role assignments...
? Assigned 3 permissions to Tenant2 User
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS0", "RequestPath": "/api/roles"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS1", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[xUnit.net 00:00:02.33]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.UpdateRole_WithDuplicateName_ShouldReturnConflict [FAIL]
?? Ensuring clean database state...
[xUnit.net 00:00:02.33]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.33]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.33]       Stack Trace:
[xUnit.net 00:00:02.33]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.33]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.33]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.33]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:02.33]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:02.33]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(141,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.UpdateRole_WithDuplicateName_ShouldReturnConflict()
[xUnit.net 00:00:02.33]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.33]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.33]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.33]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.33]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS2", "RequestPath": "/api/users"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Creating roles...
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.34]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithAdminToken_ReturnsUserList [FAIL]
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.34]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.34]       Stack Trace:
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.34]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.34]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(144,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithAdminToken_ReturnsUserList()
?? Ensuring clean database state...
[xUnit.net 00:00:02.34]         --- End of stack trace from previous location ---
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS3", "RequestPath": "/api/users/3/roles"}
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[xUnit.net 00:00:02.34]     UserService.IntegrationTests.Controllers.RolesControllerTests.AssignRoleToUser_WithValidData_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.34]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.34]       Stack Trace:
?? Ensuring clean database state...
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.34]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.34]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Database recreated with clean state
[xUnit.net 00:00:02.34]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(150,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.AssignRoleToUser_WithValidData_ReturnsSuccess()
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.34]         --- End of stack trace from previous location ---
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified required user exists: admin@tenant1.com (ID:  1)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? Verified required user exists: admin@tenant2.com (ID:  6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS4", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS5", "RequestPath": "/api/users"}
[xUnit.net 00:00:02.36]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithWrongContentType_ShouldReturnUnsupportedMediaType [FAIL]
[xUnit.net 00:00:02.36]       Expected response.StatusCode to be HttpStatusCode.UnsupportedMediaType {value: 415}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.36]       Stack Trace:
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.36]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.36]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(483,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithWrongContentType_ShouldReturnUnsupportedMediaType()
[xUnit.net 00:00:02.36]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
[xUnit.net 00:00:02.36]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithUserToken_ReturnsForbidden [FAIL]
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
[xUnit.net 00:00:02.36]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
   - reports.export (Reports)
   - reports.schedule (Reports)
[xUnit.net 00:00:02.36]       Stack Trace:
   - reports.view (Reports)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
   - roles.assign_users (Roles)
   - roles.create (Roles)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
   - roles.delete (Roles)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
   - roles.edit (Roles)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - system.manage (System)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - system.manage_backups (System)
   - system.manage_settings (System)
[xUnit.net 00:00:02.36]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - system.monitor (System)
[xUnit.net 00:00:02.36]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(165,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithUserToken_ReturnsForbidden()
   - system.view_logs (System)
[xUnit.net 00:00:02.36]         --- End of stack trace from previous location ---
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Created 38 permissions
? Verified user: user@tenant1.com (ID: 2)
?? Creating roles...
? Verified user: admin@tenant2.com (ID: 6)
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS6", "RequestPath": "/api/roles/9999/users"}
?? Ensuring clean database state...
[xUnit.net 00:00:02.36]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithNonExistentRole_ReturnsNotFound [FAIL]
? Database recreated with clean state
[xUnit.net 00:00:02.36]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.36]       Stack Trace:
?? Creating tenants...
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.36]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.36]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.36]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(391,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithNonExistentRole_ReturnsNotFound()
[xUnit.net 00:00:02.36]         --- End of stack trace from previous location ---
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Created 109 role permissions using only actual business-defined permissions
? Assigned 3 permissions to Tenant2 User
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 8 user role assignments
?? Creating legacy tenant users...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant2.com (ID: 6)
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS7", "RequestPath": "/api/roles/-1"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS8", "RequestPath": "/api/users/2/roles"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[xUnit.net 00:00:02.38]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRole_WithNegativeId_ShouldReturnBadRequest [FAIL]
[xUnit.net 00:00:02.38]       Expected response.StatusCode to be one of {HttpStatusCode.BadRequest {value: 400}, HttpStatusCode.NotFound {value: 404}}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.38]       Stack Trace:
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.38]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(IEnumerable`1 validValues, String because, Object[] becauseArgs)
? Database recreated with clean state
[xUnit.net 00:00:02.38]            at FluentAssertions.Primitives.EnumAssertions`2.BeOneOf(TEnum[] validValues)
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
[xUnit.net 00:00:02.38]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(283,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.GetRole_WithNegativeId_ShouldReturnBadRequest()
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[xUnit.net 00:00:02.38]         --- End of stack trace from previous location ---
?? Creating tenants...
[xUnit.net 00:00:02.38]     UserService.IntegrationTests.Controllers.UsersControllerTests.AssignRoleToUser_WithValidData_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.38]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.38]       Stack Trace:
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.38]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.38]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.38]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(599,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.AssignRoleToUser_WithValidData_ReturnsSuccess()
? Created 2 tenants
[xUnit.net 00:00:02.38]         --- End of stack trace from previous location ---
?? Creating permissions...
? Created 2 tenants
?? Creating permissions...
?? Generated tenant-aware JWT for user@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: User
   - Permissions: 3
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
?? Creating 38 permissions from actual business requirements
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - billing.manage (Billing)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - system.manage_backups (System)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - system.manage_settings (System)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - tenants.initialize (Tenants)
   - users.view (Users)
   - users.view_all (Users)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TS9", "RequestPath": "/api/roles/2/users"}
? Created 38 permissions
? Created 38 permissions
?? Creating roles...
?? Creating roles...
?? CreateRoles DEBUG:
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant1.Id = 1
   - tenant2.Id = 2
   - tenant2.Id = 2
?? Roles to be created (8):
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   4. Manager (TenantId: 1)
   7. Admin (TenantId: 2)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
? Created 8 roles
[xUnit.net 00:00:02.39]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithoutPermission_ReturnsForbidden [FAIL]
?? Verification - Created roles:
?? Verification - Created roles:
[xUnit.net 00:00:02.39]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:02.39]       Stack Trace:
   - ID=8, Name='User', TenantId=2
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
   - ID=6, Name='Editor', TenantId=1
[xUnit.net 00:00:02.39]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.39]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
   - ID=7, Name='Admin', TenantId=2
[xUnit.net 00:00:02.39]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(540,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithoutPermission_ReturnsForbidden()
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
[xUnit.net 00:00:02.39]         --- End of stack trace from previous location ---
   - ID=4, Name='Manager', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
? Successfully created all 8 roles including 2 Tenant 2 roles
   - ID=1, Name='SuperAdmin', TenantId=
?? Creating role permissions...
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Ensuring clean database state...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
? Assigned 3 permissions to Tenant1 User
? Assigned 28 permissions to Tenant1 Admin
?? Creating tenants...
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Tenant1 User
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2.Id = 2
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
   - All roles count: 8
   - Roles with TenantId = 2: 2
?? DEBUG: Found 28 permissions for Tenant2 Admin
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant1.com (ID: 1)
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: user@tenant1.com (ID: 2)
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Verified user: admin@tenant2.com (ID: 6)
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSA", "RequestPath": "/api/roles"}
?? Generated tenant-aware JWT for manager@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Manager
   - Permissions: 6
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSB", "RequestPath": "/api/roles/2/users"}
[xUnit.net 00:00:02.41]     UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithNullName_ShouldReturnBadRequest [FAIL]
[xUnit.net 00:00:02.41]       Expected response.StatusCode to be HttpStatusCode.BadRequest {value: 400}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.41]       Stack Trace:
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.41]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.41]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\ErrorHandling\EdgeCaseErrorHandlingTests.cs(63,0): at UserService.IntegrationTests.ErrorHandling.EdgeCaseErrorHandlingTests.CreateRole_WithNullName_ShouldReturnBadRequest()
[xUnit.net 00:00:02.41]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.41]     UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithManagerRole_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.41]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.41]       Stack Trace:
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.41]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.41]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(554,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.GetRoleUsers_WithManagerRole_ReturnsSuccess()
[xUnit.net 00:00:02.41]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSC", "RequestPath": "/api/users/2/status"}
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[xUnit.net 00:00:02.41]     UserService.IntegrationTests.Controllers.UsersControllerTests.UpdateUserStatus_WithValidData_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.41]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.41]       Stack Trace:
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.41]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.41]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.41]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(657,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.UpdateUserStatus_WithValidData_ReturnsSuccess()
[xUnit.net 00:00:02.41]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSD", "RequestPath": "/api/roles"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSE", "RequestPath": "/api/users/999"}
[xUnit.net 00:00:02.43]     UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRolePermissions_RemoveAllPermissions_ReturnsSuccess [FAIL]
[xUnit.net 00:00:02.43]       System.Text.Json.JsonException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. Path: $ | LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.43]       ---- System.Text.Json.JsonReaderException : The input does not contain any JSON tokens. Expected the input to start with a valid JSON token, when isFinalBlock is true. LineNumber: 0 | BytePositionInLine: 0.
[xUnit.net 00:00:02.43]       Stack Trace:
[xUnit.net 00:00:02.43]            at System.Text.Json.ThrowHelper.ReThrowWithPath(ReadStack& state, JsonReaderException ex)
[xUnit.net 00:00:02.43]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.43]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.ContinueDeserialize(ReadBufferState& bufferState, JsonReaderState& jsonReaderState, ReadStack& readStack, T& value)
[xUnit.net 00:00:02.43]            at System.Text.Json.Serialization.Metadata.JsonTypeInfo`1.DeserializeAsync(Stream utf8Json, CancellationToken cancellationToken)
[xUnit.net 00:00:02.43]            at System.Net.Http.Json.HttpContentJsonExtensions.ReadFromJsonAsyncCore[T](HttpContent content, JsonSerializerOptions options, CancellationToken cancellationToken)
[xUnit.net 00:00:02.43]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\RolesControllerTests.cs(603,0): at UserService.IntegrationTests.Controllers.RolesControllerTests.UpdateRolePermissions_RemoveAllPermissions_ReturnsSuccess()
[xUnit.net 00:00:02.43]         --- End of stack trace from previous location ---
[xUnit.net 00:00:02.43]         ----- Inner Stack Trace -----
[xUnit.net 00:00:02.43]            at System.Text.Json.ThrowHelper.ThrowJsonReaderException(Utf8JsonReader& json, ExceptionResource resource, Byte nextByte, ReadOnlySpan`1 bytes)
[xUnit.net 00:00:02.43]            at System.Text.Json.Utf8JsonReader.Read()
[xUnit.net 00:00:02.43]            at System.Text.Json.Serialization.JsonConverter`1.ReadCore(Utf8JsonReader& reader, T& value, JsonSerializerOptions options, ReadStack& state)
[xUnit.net 00:00:02.43]     UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_NonExistentUser_ReturnsNotFound [FAIL]
[xUnit.net 00:00:02.43]       Expected response.StatusCode to be HttpStatusCode.NotFound {value: 404}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.43]       Stack Trace:
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.43]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.43]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.43]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(475,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.DeleteUser_NonExistentUser_ReturnsNotFound()
[xUnit.net 00:00:02.43]         --- End of stack trace from previous location ---
?? Ensuring clean database state...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
=== UserService Startup Diagnostics ===
?? DEBUG: Found 28 permissions for Tenant2 Admin
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
[Startup] Monitoring:Enabled raw config value = 'False'
?? Registering base services...
? Base services registered
?? Configuring Swagger...
? Swagger configured
?? Registering common services...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
? Redis configured
?? Registering database services...
? Database services registered
?? Registering user services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Application built successfully
?? Configuring middleware pipeline...
?? Configuring Enhanced Security middleware...
[12:51:32 INF] Configuring Enhanced Security middleware {}
? Created 8 user role assignments
?? Creating legacy tenant users...
[12:51:32 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
? Enhanced Security middleware configured successfully
[12:51:32 INF] Enhanced Security middleware configured successfully {}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 INF] Failed to validate the token. {"EventId": {"Id": 1, "Name": "TokenValidationFailed"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TSF", "RequestPath": "/api/users"}
Microsoft.IdentityModel.Tokens.SecurityTokenSignatureKeyNotFoundException: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details.
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignature(JsonWebToken jwtToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateSignatureAndIssuerSecurityKey(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
[12:51:32 INF] Bearer was not authenticated. Failure message: IDX10517: Signature validation failed. The token's kid is missing. Keys tried: 'Microsoft.IdentityModel.Tokens.SymmetricSecurityKey, KeyId: '', InternalId: 'RJ4xZ72p2M6uzSkK2bvQTp7dmBcGXkxM3Mul0J37AYw'. , KeyId: 
'. Number of keys in TokenValidationParameters: '1'. 
Number of keys in Configuration: '0'. 
Exceptions caught:
 '[PII of type 'System.String' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'.
token: '[PII of type 'Microsoft.IdentityModel.JsonWebTokens.JsonWebToken' is hidden. For more details, see https://aka.ms/IdentityModel/PII.]'. See https://aka.ms/IDX10503 for details. {"EventId": {"Id": 7, "Name": "AuthenticationSchemeNotAuthenticatedWithFailure"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TSF", "RequestPath": "/api/users"}
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSF", "RequestPath": "/api/users"}
[12:51:32 INF] AuthenticationScheme: Bearer was challenged. {"EventId": {"Id": 12, "Name": "AuthenticationSchemeChallenged"}, "SourceContext": "Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerHandler", "RequestId": "0HNF2DMOP3TSF", "RequestPath": "/api/users"}
[12:51:32 INF] HTTP GET /api/users responded 401 in 1.3411 ms {"SourceContext": "Serilog.AspNetCore.RequestLoggingMiddleware"}
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
[xUnit.net 00:00:02.47]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithPagination_ReturnsCorrectPage [FAIL]
[xUnit.net 00:00:02.47]       Expected response.StatusCode to be HttpStatusCode.OK {value: 200}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.47]       Stack Trace:
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.47]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
?? Ensuring clean database state...
[xUnit.net 00:00:02.47]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
? Enhanced Health Check endpoints mapped
[xUnit.net 00:00:02.47]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(198,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUsers_WithPagination_ReturnsCorrectPage()
[12:51:32 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
[xUnit.net 00:00:02.47]         --- End of stack trace from previous location ---
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
[12:51:32 INF] Redis connection status: Connected {}
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
? Redis connection successful: 8/23/2025 5:51:32 PM
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
[12:51:32 INF] Redis connection test successful: 8/23/2025 5:51:32 PM {}
?? Seeding database...
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? Database seeded
?? Seeding monitoring user...
[12:51:32 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:32 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for admin@tenant1.com:
   - Tenant: Test Tenant 1 (ID: 1)
   - Roles: Admin
   - Permissions: 28
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSG", "RequestPath": "/api/users"}
[xUnit.net 00:00:02.49]     UserService.IntegrationTests.Controllers.UsersControllerTests.CreateUser_ViaAPI_ShouldCreateActiveUser [FAIL]
[xUnit.net 00:00:02.49]       Expected response.StatusCode to be HttpStatusCode.Created {value: 201}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.49]       Stack Trace:
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
?? Ensuring clean database state...
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.49]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.49]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.49]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(684,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.CreateUser_ViaAPI_ShouldCreateActiveUser()
[xUnit.net 00:00:02.49]         --- End of stack trace from previous location ---
? Database recreated with clean state
?? TestDataSeeder: Starting test data seeding
?? Creating tenants...
? Created 2 tenants
?? Creating permissions...
?? Creating 38 permissions from actual business requirements
   - billing.manage (Billing)
   - billing.process_payments (Billing)
   - billing.view (Billing)
   - billing.view_invoices (Billing)
   - permissions.create (Permissions)
   - permissions.delete (Permissions)
   - permissions.edit (Permissions)
   - permissions.manage (Permissions)
   - permissions.view (Permissions)
   - reports.create (Reports)
   - reports.export (Reports)
   - reports.schedule (Reports)
   - reports.view (Reports)
   - roles.assign_users (Roles)
   - roles.create (Roles)
   - roles.delete (Roles)
   - roles.edit (Roles)
   - roles.manage_permissions (Roles)
   - roles.view (Roles)
   - system.manage (System)
   - system.manage_backups (System)
   - system.manage_settings (System)
   - system.monitor (System)
   - system.view_logs (System)
   - system.view_metrics (System)
   - tenants.create (Tenants)
   - tenants.delete (Tenants)
   - tenants.edit (Tenants)
   - tenants.initialize (Tenants)
   - tenants.manage_settings (Tenants)
   - tenants.view (Tenants)
   - tenants.view_all (Tenants)
   - users.create (Users)
   - users.delete (Users)
   - users.edit (Users)
   - users.manage_roles (Users)
   - users.view (Users)
   - users.view_all (Users)
? Created 38 permissions
?? Creating roles...
?? CreateRoles DEBUG:
   - tenant1.Id = 1
   - tenant2.Id = 2
?? Roles to be created (8):
   1. SuperAdmin (TenantId: )
   2. Admin (TenantId: 1)
   3. User (TenantId: 1)
   4. Manager (TenantId: 1)
   5. Viewer (TenantId: 1)
   6. Editor (TenantId: 1)
   7. Admin (TenantId: 2)
   8. User (TenantId: 2)
? Created 8 roles
?? Verification - Created roles:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Successfully created all 8 roles including 2 Tenant 2 roles
?? Creating role permissions...
?? Found 38 permissions and 8 roles
?? ALL LOADED ROLES:
   - ID=8, Name='User', TenantId=2
   - ID=7, Name='Admin', TenantId=2
   - ID=6, Name='Editor', TenantId=1
   - ID=5, Name='Viewer', TenantId=1
   - ID=4, Name='Manager', TenantId=1
   - ID=3, Name='User', TenantId=1
   - ID=2, Name='Admin', TenantId=1
   - ID=1, Name='SuperAdmin', TenantId=
? Assigned 38 permissions to SuperAdmin
? Assigned 28 permissions to Tenant1 Admin
? Assigned 3 permissions to Tenant1 User
? Assigned 6 permissions to Tenant1 Manager
? Assigned 3 permissions to Viewer
?? TENANT 2 ADMIN DEBUG:
   - tenant2.Id = 2
   - All roles count: 8
   - Roles with TenantId = 2: 2
   - Admin roles: ID=7, TenantId=2, ID=2, TenantId=1
   - tenant2AdminRole found: True
   - tenant2AdminRole.Id = 7
?? DEBUG: Found 28 permissions for Tenant2 Admin
? Assigned 28 permissions to Tenant2 Admin (Expected: 23+)
? Assigned 3 permissions to Tenant2 User
? Created 109 role permissions using only actual business-defined permissions
?? Creating users...
?? Adding 7 users to main context
? All users created successfully
? Final user count: 7
? Verified required user exists: admin@tenant1.com (ID:  1)
? Verified required user exists: user@tenant1.com (ID:  2)
? Verified required user exists: admin@tenant2.com (ID:  6)
? Verified required user exists: user@tenant2.com (ID:  7)
?? All users created and verified successfully!
?? Creating user role assignments...
?? Found 7 users and 8 roles for assignment
?? Adding 8 user role assignments...
? Created 8 user role assignments
?? Creating legacy tenant users...
? Created 7 legacy tenant users
?? Verifying test data...
?? Temporarily disabling query filters for verification...
?? Final counts: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109
? Verified user: admin@tenant1.com (ID: 1)
? Verified user: user@tenant1.com (ID: 2)
? Verified user: admin@tenant2.com (ID: 6)
? admin@tenant1.com has 1 role assignments
? TestDataSeeder: Test data seeding completed successfully
[12:51:32 INF] ?? Test Data Status: Tenants=2, Users=7, Roles=8, Permissions=38, UserRoles=8, RolePermissions=109 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Tenant IDs: Tenant1=1, Tenant2=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? User IDs: Admin=1, User=2 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF] ?? Admin user analysis: {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Email: admin@tenant1.com {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - UserRoles count: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Active UserRoles: 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Permissions: 28 [users.view, users.edit, users.create, users.delete, users.view_all, users.manage_roles, roles.view, roles.create, roles.edit, roles.delete, roles.assign_users, roles.manage_permissions, tenants.view, tenants.create, tenants.edit, tenants.delete, tenants.initialize, tenants.view_all, tenants.manage_settings, reports.view, reports.create, reports.export, reports.schedule, permissions.view, permissions.create, permissions.edit, permissions.delete, permissions.manage] {"SourceContext": "UserService.IntegrationTests.TestBase"}
[12:51:32 INF]    - Tenant: Test Tenant 1 {"SourceContext": "UserService.IntegrationTests.TestBase"}
?? Generated tenant-aware JWT for user@tenant2.com:
   - Tenant: Test Tenant 2 (ID: 2)
   - Roles: User
   - Permissions: 3
[12:51:32 DBG] Policy authentication schemes  did not succeed {"SourceContext": "Microsoft.AspNetCore.Authorization.AuthorizationMiddleware", "RequestId": "0HNF2DMOP3TSH", "RequestPath": "/api/users/4"}
[xUnit.net 00:00:02.51]     UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_UserAccessingOtherUser_ReturnsForbidden [FAIL]
[xUnit.net 00:00:02.51]       Expected response.StatusCode to be HttpStatusCode.Forbidden {value: 403}, but found HttpStatusCode.Unauthorized {value: 401}.
[xUnit.net 00:00:02.51]       Stack Trace:
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.XUnit2TestFramework.Throw(String message)
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.TestFrameworkProvider.Throw(String message)
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.DefaultAssertionStrategy.HandleFailure(String message)
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.AssertionScope.FailWith(Func`1 failReasonFunc)
[xUnit.net 00:00:02.51]            at FluentAssertions.Execution.AssertionScope.FailWith(String message, Object[] args)
[xUnit.net 00:00:02.51]            at FluentAssertions.Primitives.EnumAssertions`2.Be(TEnum expected, String because, Object[] becauseArgs)
[xUnit.net 00:00:02.51]         C:\Users\mccre\dev\boiler\tests\integration\UserService.IntegrationTests\Controllers\UsersControllerTests.cs(276,0): at UserService.IntegrationTests.Controllers.UsersControllerTests.GetUser_UserAccessingOtherUser_ReturnsForbidden()
[xUnit.net 00:00:02.51]         --- End of stack trace from previous location ---
=== UserService Startup Diagnostics ===
Environment: Testing
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
[Startup] Monitoring:Enabled raw config value = 'False'
?? Registering base services...
? Base services registered
?? Configuring Swagger...
? Swagger configured
?? Registering common services...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
? Redis configured
?? Registering database services...
? Database services registered
?? Registering user services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Application built successfully
?? Configuring middleware pipeline...
?? Configuring Enhanced Security middleware...
[12:51:32 INF] Configuring Enhanced Security middleware {}
[12:51:32 INF] ?? Enhanced security middleware DISABLED in testing environment {"SourceContext": "SecurityExtensions"}
? Enhanced Security middleware configured successfully
[12:51:32 INF] Enhanced Security middleware configured successfully {}
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Enhanced Health Check endpoints mapped
[12:51:32 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
[12:51:32 INF] Redis connection status: Connected {}
? Redis connection successful: 8/23/2025 5:51:32 PM
[12:51:32 INF] Redis connection test successful: 8/23/2025 5:51:32 PM {}
?? Seeding database...
? Database seeded
?? Seeding monitoring user...
[12:51:32 INF] Monitoring.Enabled = 'false' (evaluated false); skipping seeding. {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:32 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[xUnit.net 00:00:02.56]   Finished:    UserService.IntegrationTests
[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.5.3.1+6b60a9e56a (64-bit .NET 9.0.7)
[xUnit.net 00:00:00.05]   Starting:    UserService.PerformanceTests
=== UserService Startup Diagnostics ===
Environment: Performance
Application Name: UserService
Content Root: C:\Users\mccre\dev\boiler\src\services\UserService
Running in Container: 
[Startup] Monitoring:Enabled raw config value = 'True'
?? Registering base services...
? Base services registered
?? Configuring Swagger...
? Swagger configured
?? Registering common services...
? Common services registered
?? Configuring Redis...
?? Redis connection string resolved to: localhost:6379
?? Running in container: 
? Redis configured
?? Registering database services...
? Database services registered
?? Registering user services...
? User services registered
?? Registering Enhanced Security and Monitoring services...
? Enhanced Security and Monitoring services registered successfully
?? Registering Compliance and Alert services...
? Compliance and Alert services registered successfully
?? Registering Enhanced Health Checks...
? Enhanced Health Checks registered
?? Configuring authorization policies...
? Authorization policies configured
?? Configuring CORS...
? CORS configured
?? Registering additional services...
? Additional services registered
??? Building application...
? Application built successfully
?? Configuring middleware pipeline...
?? Configuring Enhanced Security middleware...
[12:51:33 INF] Configuring Enhanced Security middleware {}
? Enhanced Security middleware configured successfully
[12:51:33 INF] Enhanced Security middleware configured successfully {}
? Middleware pipeline configured
?? Mapping Enhanced Health Check endpoints...
? Enhanced Health Check endpoints mapped
[12:51:33 INF] Starting UserService with Phase 11 Enhanced Security & Monitoring {}
=== UserService Starting with Phase 11 Enhanced Security & Monitoring ===
?? Testing Redis connection...
[12:51:33 INF] Attempting to connect to Redis at: localhost:6379 {"SourceContext": "Program"}
[12:51:41 INF] Redis connection status: Disconnected to localhost:6379 {"SourceContext": "Program"}
[12:51:41 INF] Redis connection status: Disconnected {}
?? Seeding database...
? Database seeded
?? Seeding monitoring user...
[12:51:42 INF] Config snapshot: Monitoring:Enabled='True' {"SourceContext": "MonitoringUserSeeder"}
[12:51:42 INF] Seeding system-wide monitoring account (Email: monitor@local) {"SourceContext": "MonitoringUserSeeder"}
[12:51:42 INF] Created new system Monitor role {"SourceContext": "MonitoringUserSeeder"}
[12:51:42 INF] Linked system Monitor role to permission system.view_metrics {"SourceContext": "MonitoringUserSeeder"}
[12:51:42 INF] Assigned system Monitor role to monitoring user {"SourceContext": "MonitoringUserSeeder"}
[12:51:42 INF] Monitoring user ready. login_email=monitor@local password=ChangeMe123! {"SourceContext": "MonitoringUserSeeder"}
? Monitoring user seeded (monitor@local / ChangeMe123!)
?? Starting application...
?? Enhanced Health Check endpoints available:
  - GET /health (comprehensive overview)
  - GET /health/critical (database + Redis status)
  - GET /health/enhanced (Phase 11 enhanced monitoring)
  - GET /health/performance (cache and performance metrics)
  - GET /health/system (overall system health score)
  - GET /health/ready (Kubernetes readiness)
  - GET /health/live (Kubernetes liveness)
?? Enhanced Security & Monitoring features:
  - Rate limiting with tenant awareness
  - Security event detection and logging
  - Performance metrics collection with Redis storage
  - Enhanced audit trail for all actions
  - Comprehensive health monitoring with performance scoring
  - Real-time system metrics and alerts
[12:51:42 INF] Enhanced Security & Monitoring (Phase 11) configured and operational {}
[12:51:42 INF] ?? Starting performance data seeding... {"SourceContext": "UserService.PerformanceTests.BasicPerformanceTests"}
[12:51:42 INF] ? Created 5 tenants {"SourceContext": "UserService.PerformanceTests.BasicPerformanceTests"}
[12:51:42 INF] ? Created 15 permissions {"SourceContext": "UserService.PerformanceTests.BasicPerformanceTests"}
[12:51:45 INF] ? Created 20 users with role assignments for Performance Tenant 1 {"SourceContext": "UserService.PerformanceTests.BasicPerformanceTests"}
